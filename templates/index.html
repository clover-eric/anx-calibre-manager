{% extends "base.html" %}

{% block title %}书库 - Anx Calibre Manager{% endblock %}

{% block content %}
<!-- Data Island for Books -->
<script id="anx-books-data" type="application/json">{{ anx_books | tojson | safe }}</script>
<script id="calibre-books-data" type="application/json">{{ calibre_books | tojson | safe }}</script>

<div class="main-content" data-username="{{ g.user.username }}">
    <div class="library-container">
        <!-- Calibre Library Section -->
        <div class="library" id="calibre-library">
            <div class="loading-overlay" id="calibre-loading-overlay" style="display: none;">
                <div class="spinner"></div>
            </div>
            <div class="library-header">
                <div class="header-actions">
                    <button type="button" class="button-primary" data-action="go-home">首页</button>                   
                    <form action="/" method="get" class="search-form">
                        <input type="text" name="search" placeholder="搜索 Calibre 书籍..." value="{{ search_query }}">
                        <button type="submit" class="button-primary"><i class="fas fa-search"></i></button>
                    </form>
                    <button type="button" class="button-primary" data-action="show-upload-modal">上传</button>
                </div>
            </div>
            <div class="pagination-controls" data-total-pages="{{ pagination.total_pages }}">
                 <span>共 {{ pagination.total_books }} 本 ({{ pagination.page }}/{{ pagination.total_pages }})
</span>
                <form action="/" method="get" class="pagination-form" id="pagination-form">
                    <input type="hidden" name="search" value="{{ search_query }}">
                    <select name="page_size">
                        <option value="20" {% if pagination.page_size == 20 %}selected{% endif %}>20/页</option>
                        <option value="50" {% if pagination.page_size == 50 %}selected{% endif %}>50/页</option>
                        <option value="100" {% if pagination.page_size == 100 %}selected{% endif %}>100/页</option>
                    </select>
                    {% if pagination.page > 1 %}<a href="?search={{ search_query }}&page={{ pagination.page - 1 }}&page_size={{ pagination.page_size }}" class="button button-link pagination-link">上一页</a>{% endif %}
                    <input type="number" name="page" id="page-jump-input" class="page-jump-input" value="{{ pagination.page }}" min="1" max="{{ pagination.total_pages }}">
                    <button type="button" class="button" data-action="jump-to-page">跳转</button>
                    {% if pagination.page < pagination.total_pages %}<a href="?search={{ search_query }}&page={{ pagination.page + 1 }}&page_size={{ pagination.page_size }}" class="button button-link pagination-link">下一页</a>{% endif %}
                </form>
            </div>
            <div class="book-list" id="calibre-book-list">
                {% for book in calibre_books %}
                <div class="book-row" data-book-id="{{ book.id }}">
                    <div class="cover">
                        <img src="{{ url_for('main.calibre_cover', book_id=book.id) }}" alt="{{ book.title }}">
                    </div>
                    <div class="info">
                        <h3>{{ book.title }}</h3>
                        <p class="author">{{ book.authors | join(', ') }}</p>
                        <div class="extra-details">
                            {% if book.rating is not none and book.rating | string | length > 0 and book.rating|float > 0 %}<span><strong>Rating:</strong> {{ "%.1f" | format(book.rating) }}/5</span><br>{% endif %}
                            <span><strong>格式:</strong> {{ book.formats_with_sizes | join(', ') }}</span><br>
                            {% if book.publisher and book.publisher != 'None' %}<span><strong>出版社:</strong> {{ book.publisher }}</span><br>{% endif %}
                            {% if book.pubdate and book.pubdate != 'None' and not book.pubdate.startswith('0101-01') %}<span><strong>出版日期:</strong> {{ book.pubdate.split('T')[0] }}</span><br>{% endif %}
                            {% set library = book.user_metadata['#library'] %}
                            {% if library and library['#value#'] and library['#value#'] != 'None' %}
                                <span><strong>库:</strong> {{ library['#value#'] }}</span><br>
                            {% endif %}
                            {% set readdate = book.user_metadata['#readdate'] %}
                            {% if readdate and readdate['#value#'] and readdate['#value#'] != 'None' and not readdate['#value#'].startswith('0101-01') %}
                                <span><strong>已读日期:</strong> {{ readdate['#value#'].split('T')[0] }}</span><br>
                            {% endif %}
                             {% if book.comments %}<p class="description" style="margin-top: 5px;"><strong>描述:</strong> {{ book.comments | striptags | truncate(150, True) }}</p>{% endif %}
                        </div>
                    </div>
                    <div class="actions">
                        <button class="button" data-action="download-calibre" data-id="{{ book.id }}"><span class="button-text">下载</span></button>
                        <button class="button" data-action="send-kindle" data-id="{{ book.id }}"><span class="button-text">Kindle</span></button>
                        <button class="button button-secondary" data-action="push-to-anx" data-id="{{ book.id }}"><span class="button-text">Anx</span></button>
                        {% set library_field = book.get('user_metadata', {}).get('#library', {}) %}
                        {% set library_owner = library_field.get('#value#', '').removesuffix('上传') if library_field and library_field.get('#value#') else '' %}
                        {% if g.user.is_maintainer or (library_owner and g.user.username == library_owner) %}
                        <button class="button edit-button" data-action="edit-calibre" data-id="{{ book.id }}"><span class="button-text">编辑</span></button>
                        {% endif %}
                    </div>
                </div>
                {% else %}
                <p>Calibre 书库中没有书籍。</p>
                {% endfor %}
            </div>
            <div class="pagination-controls bottom" data-total-pages="{{ pagination.total_pages }}">
                 <span>共 {{ pagination.total_books }} 本 ({{ pagination.page }}/{{ pagination.total_pages }})
</span>
                <form action="/" method="get" class="pagination-form" id="pagination-form-bottom">
                    <input type="hidden" name="search" value="{{ search_query }}">
                    <select name="page_size">
                        <option value="20" {% if pagination.page_size == 20 %}selected{% endif %}>20/页</option>
                        <option value="50" {% if pagination.page_size == 50 %}selected{% endif %}>50/页</option>
                        <option value="100" {% if pagination.page_size == 100 %}selected{% endif %}>100/页</option>
                    </select>
                    {% if pagination.page > 1 %}<a href="?search={{ search_query }}&page={{ pagination.page - 1 }}&page_size={{ pagination.page_size }}" class="button button-link pagination-link">上一页</a>{% endif %}
                    <input type="number" name="page" id="page-jump-input-bottom" class="page-jump-input" value="{{ pagination.page }}" min="1" max="{{ pagination.total_pages }}">
                    <button type="button" class="button" data-action="jump-to-page-bottom">跳转</button>
                    {% if pagination.page < pagination.total_pages %}<a href="?search={{ search_query }}&page={{ pagination.page + 1 }}&page_size={{ pagination.page_size }}" class="button button-link pagination-link">下一页</a>{% endif %}
                </form>
            </div>
        </div>
        <!-- Anx Library Section -->
        <div class="library" id="anx-library">
            <div class="library-header">
                <h2>Anx 书库</h2>
            </div>
            <div id="anx-library-subheader">
                 <p class="webdav-info">在 Anx Reader 设置页面中填入 WebDAV 地址进行同步（用户名密码为你的登录用户名密码）: <span id="anx-webdav-url" class="webdav-url" title="点击复制"></span></p>
            </div>
            <div class="book-list" id="anx-book-list">
                {% for book in anx_books %}
            
                <div class="book-row" data-book-id="{{ book.id }}">
                    <div class="cover">
                        {% if book.cover_path %}<img src="{{ url_for('main.anx_cover', cover_path=book.cover_path) }}" alt="{{ book.title }}">
                        {% else %}<img src="https://via.placeholder.com/100x150.png?text=No+Cover" alt="No Cover">{% endif %}
                    </div>
                    <div class="info">
                        <h3>{{ book.title }}</h3>
                        <p class="author">{{ book.author }}</p>
                        <div class="extra-details">
                            {% if book.rating is not none and book.rating | string | length > 0 and book.rating|float > 0 %}<span><strong>评分:</strong> {{ "%.1f" | format(book.rating) }}/5</span><br>{% endif %}
                            {% if book.publisher %}<span><strong>出版社:</strong> {{ book.publisher }}</span><br>{% endif %}
                             <span><strong>阅读进度:</strong> {% if book.reading_percentage is not none %}{{ "%.1f" | format(book.reading_percentage * 100) }}%{% else %}0.0%{% endif %}</span><br>
                             <span><strong>总阅读时长:</strong> {{ book.formatted_reading_time }}</span><br>
                             <span><strong>笔记数量:</strong> {{ book.note_count }}</span><br>
                            {% if book.create_time %}<span><strong>创建时间:</strong> {{ book.create_time.split('T')[0] }}</span><br>{% endif %}
                            {% if book.update_time %}<span><strong>更新时间:</strong> {{ book.update_time.split('T')[0] }}</span><br>{% endif %}
                            {% if book.book_producer %}<span><strong>制作人:</strong> {{ book.book_producer }}</span><br>{% endif %}
                            {% if book.description %}<p class="description" style="margin-top: 5px;"><strong>描述:</strong> {{ book.description | truncate(150, True) }}</p>{% endif %}
                        </div>
                    </div>
                    <div class="actions">
                        <button class="button" data-action="download-anx" data-id="{{ book.id }}"><span class="button-text">下载</span></button>
                        <button class="button edit-button" data-action="edit-anx" data-id="{{ book.id }}"><span class="button-text">编辑</span></button>
                        <button class="button button-danger" data-action="delete-anx" data-id="{{ book.id }}"><span class="button-text">删除</span></button>
                    </div>
                </div>
                {% else %}

                <p>Anx 书库中没有书籍。</p>
                {% endfor %}
            </div>
        </div>

    </div>
</div>

<!-- Modals -->
<div id="uploadModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>上传书籍</h2>
            <button class="close-button" data-action="close-modal">&times;</button>
        </div>
         <div class="modal-body">
            <form id="uploadForm" method="post" enctype="multipart/form-data">
                <div class="form-group">
                    <label for="book-upload-input">选择文件:</label>
                    <input id="book-upload-input" type="file" name="books" required multiple>
                </div>
                <div id="upload-progress-container" class="upload-progress-container"></div>
                <div class="modal-footer">
                     <button type="button" class="button" data-action="close-modal">取消</button>
                    <button type="submit" class="button-primary">上传</button>
                </div>
            </form>
        </div>
    </div>
</div>
<div id="editBookModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 id="edit-modal-title">编辑书籍信息</h2>
            <button class="close-button" data-action="close-modal">&times;</button>
        </div>
        <div class="modal-body">
            <form id="editBookForm"></form>
        </div>
        <div class="modal-footer">
            <button type="button" class="button" data-action="close-modal">取消</button>
            <button type="button" class="button-primary" data-action="save-changes"><span class="button-text">保存</span></button>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script type="module" src="{{ url_for('static', filename='js/index.js') }}"></script>
{% endblock %}