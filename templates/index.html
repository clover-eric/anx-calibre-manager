{% extends "base.html" %}

{% block title %}{{ _('Library') }} - Anx Calibre Manager{% endblock %}

{% block content %}
<!-- Data Island for Books -->
<script id="anx-books-data" type="application/json">{{ anx_books | tojson | safe }}</script>
<script id="calibre-books-data" type="application/json">{{ calibre_books | tojson | safe }}</script>
<script id="calibre-error-data" type="application/json">{{ calibre_error | tojson | safe }}</script>

<div class="main-content" data-username="{{ g.user.username }}" data-enable-activity-log="{{ 'true' if enable_activity_log else 'false' }}">
    <div class="library-container">
        <!-- Calibre Library Section -->
        <div class="library" id="calibre-library">
            <div class="loading-overlay" id="calibre-loading-overlay" style="display: none;">
                <div class="spinner"></div>
            </div>
            <div class="library-header">
                <div class="header-actions">
                    <button type="button" class="button-primary" data-action="go-home">{{ _('Home') }}</button>
                    <form action="/" method="get" class="search-form">
                        <input type="text" name="search" placeholder="{{ _('Search Calibre books...') }}" value="{{ search_query }}">
                        <button type="submit" class="button-primary"><i class="fas fa-search"></i></button>
                    </form>
                    {% if not (disable_normal_user_upload and g.user.role == 'user') %}
                    <button type="button" class="button-primary" data-action="show-upload-modal">{{ _('Upload') }}</button>
                    {% endif %}
                </div>
            </div>
            <div class="pagination-controls" data-total-pages="{{ pagination.total_pages }}">
                 <span>{{ _('Total %(total_books)s books (%(page)s/%(total_pages)s)', total_books=pagination.total_books, page=pagination.page, total_pages=pagination.total_pages) }}
</span>
                <form action="/" method="get" class="pagination-form" id="pagination-form">
                    <input type="hidden" name="search" value="{{ search_query }}">
                    <select name="page_size">
                        <option value="20" {% if pagination.page_size == 20 %}selected{% endif %}>{{ _('20/page') }}</option>
                        <option value="50" {% if pagination.page_size == 50 %}selected{% endif %}>{{ _('50/page') }}</option>
                        <option value="100" {% if pagination.page_size == 100 %}selected{% endif %}>{{ _('100/page') }}</option>
                    </select>
                    {% if pagination.page > 1 %}<a href="?search={{ search_query }}&page={{ pagination.page - 1 }}&page_size={{ pagination.page_size }}" class="button button-link pagination-link">{{ _('Previous') }}</a>{% endif %}
                    <input type="number" name="page" id="page-jump-input" class="page-jump-input" value="{{ pagination.page }}" min="1" max="{{ pagination.total_pages }}">
                    <button type="button" class="button" data-action="jump-to-page">{{ _('Go') }}</button>
                    {% if pagination.page < pagination.total_pages %}<a href="?search={{ search_query }}&page={{ pagination.page + 1 }}&page_size={{ pagination.page_size }}" class="button button-link pagination-link">{{ _('Next') }}</a>{% endif %}
                </form>
            </div>
            <div class="book-list" id="calibre-book-list">
                {% if calibre_error %}
                <div class="error-container">
                    <div class="error-icon"><i class="fas fa-exclamation-triangle"></i></div>
                    <div class="error-details">
                        {% if calibre_error.code == 'CONNECTION_ERROR' %}
                            <h3>{{ _('Calibre Connection Error') }}</h3>
                            <p><strong>{{ _('Reason:') }}</strong> {{ _('Could not connect to the Calibre server.') }}</p>
                            <p><strong >{{ _('Solution:') }}</strong> <span id="calibre-error-solution"></span></p>
                        {% elif calibre_error.code == 'UNAUTHORIZED' %}
                            <h3>{{ _('Calibre Authentication Error') }}</h3>
                            <p><strong>{{ _('Reason:') }}</strong> {{ _('The server returned a 401 Unauthorized error.') }}</p>
                            <p><strong >{{ _('Solution:') }}</strong> <span id="calibre-error-solution"></span></p>
                        {% elif calibre_error.code == 'FORBIDDEN' %}
                            <h3>{{ _('Calibre Permission Error') }}</h3>
                            <p><strong>{{ _('Reason:') }}</strong> {{ _('The server returned a 403 Forbidden error.') }}</p>
                            <p><strong >{{ _('Solution:') }}</strong> <span id="calibre-error-solution"></span></p>
                        {% elif calibre_error.code == 'HTTP_ERROR' %}
                            <h3>{{ _('Calibre HTTP Error') }}</h3>
                            <p><strong>{{ _('Reason:') }}</strong> {{ _('The server returned an HTTP %(status_code)s error.', status_code=calibre_error.status_code) }}</p>
                            <p><strong >{{ _('Solution:') }}</strong> <span id="calibre-error-solution"></span></p>
                        {% else %}
                            <h3>{{ _('Calibre Request Error') }}</h3>
                            <p><strong>{{ _('Reason:') }}</strong> {{ _('An unknown error occurred while connecting to Calibre.') }}</p>
                            <p><strong >{{ _('Solution:') }}</strong> <span id="calibre-error-solution"></span></p>
                        {% endif %}
                        <div class="error-raw-message">
                            <p><strong>{{ _('Original Error:') }}</strong> <code>{{ calibre_error.message }}</code></p>
                            <p><strong>{{ _('Request URL (click to test):') }}</strong> <a href="{{ calibre_error.calibre_url }}" target="_blank" rel="noopener noreferrer"><code>{{ calibre_error.calibre_url }}</code></a></p>
                        </div>
                    </div>
                </div>
                {% endif %}
                {% for book in calibre_books %}
                <div class="book-row" data-book-id="{{ book.id }}">
                    <div class="cover-wrapper">
                        <a href="{{ url_for('main.reader_page', book_type='calibre', book_id=book.id) }}" class="cover-link">
                            <div class="cover">
                                <img src="{{ url_for('main.calibre_cover', book_id=book.id) }}" alt="{{ book.title }}">
                                <div class="preview-overlay">
                                    <i class="fas fa-eye"></i>
                                </div>
                            </div>
                        </a>
                        <a href="{{ url_for('chat.chat_player', book_type='calibre', book_id=book.id, book_title=book.title) }}" class="button ask-ai-button"><span class="button-text">{{ _('Ask AI') }}</span></a>
                    </div>
                    <div class="info">
                        <h3>{{ book.title }}</h3>
                        <p class="author">{{ book.authors | join(', ') }}</p>
                        <div class="extra-details">
                            {% if book.rating is not none and book.rating | string | length > 0 and book.rating|float > 0 %}<span><strong>{{ _('Rating') }}:</strong> {{ "%.1f" | format(book.rating) }}/5</span><br>{% endif %}
                            <span><strong>{{ _('Formats') }}:</strong> {{ book.formats_with_sizes | join(', ') }}</span><br>
                            {% if book.publisher and book.publisher != 'None' %}<span><strong>{{ _('Publisher') }}:</strong> {{ book.publisher }}</span><br>{% endif %}
                            {% if book.pubdate and book.pubdate != 'None' and not book.pubdate.startswith('0101-01') %}<span><strong>{{ _('Publication Date') }}:</strong> {{ book.pubdate.split('T')[0] }}</span><br>{% endif %}
                            {% set library = book.user_metadata['#library'] %}
                            {% if library and library['#value#'] and library['#value#'] != 'None' %}
                                <span><strong>{{ _('Library') }}:</strong> {{ library['#value#'] }}</span><br>
                            {% endif %}
                            {% set readdate = book.user_metadata['#readdate'] %}
                            {% if readdate and readdate['#value#'] and readdate['#value#'] != 'None' and not readdate['#value#'].startswith('0101-01') %}
                                <span><strong>{{ _('Read Date') }}:</strong> {{ readdate['#value#'].split('T')[0] }}</span><br>
                            {% endif %}
                             {% if book.comments %}<p class="description" style="margin-top: 5px;"><strong>{{ _('Description') }}:</strong> {{ book.comments | striptags | truncate(150, True) }}</p>{% endif %}
                        </div>
                        {% if enable_activity_log %}
                        <div class="pushed-to-anx-indicator" style="display: none; margin-top: 8px;" title="{{ _('Pushed to Anx') }}">
                            <i class="fas fa-check-circle" style="color: #28a745; font-size: 1.2em;"></i>
                        </div>
                        {% endif %}
                    </div>
                    <div class="actions">
                        <div class="actions-main">
                            <button class="button" data-action="download-calibre" data-id="{{ book.id }}"><span class="button-text">{{ _('Download') }}</span></button>
                            <button class="button" data-action="send-kindle" data-id="{{ book.id }}"><span class="button-text">{{ _('Kindle') }}</span></button>
                            <button class="button button-secondary" data-action="push-to-anx" data-id="{{ book.id }}"><span class="button-text">{{ _('Anx') }}</span></button>
                            {% set library_field = book.get('user_metadata', {}).get('#library', {}) %}
                            {% set library_owner = library_field.get('#value#', '') if library_field and library_field.get('#value#') else '' %}
                            {% if g.user.is_maintainer or (library_owner and g.user.username == library_owner) %}
                            <button class="button edit-button" data-action="edit-calibre" data-id="{{ book.id }}"><span class="button-text">{{ _('Edit') }}</span></button>
                            {% endif %}
                        </div>
                        <div class="actions-full-width">
                            <button class="button" data-action="generate-audiobook" data-library="calibre" data-id="{{ book.id }}"><span class="button-text">{{ _('Generate Audiobook') }}</span></button>
                        </div>
                    </div>
                </div>
                {% else %}
                <p>{{ _('No books in Calibre library.') }}</p>
                {% endfor %}
            </div>
            <div class="pagination-controls bottom" data-total-pages="{{ pagination.total_pages }}">
                 <span>{{ _('Total %(total_books)s books (%(page)s/%(total_pages)s)', total_books=pagination.total_books, page=pagination.page, total_pages=pagination.total_pages) }}
</span>
                <form action="/" method="get" class="pagination-form" id="pagination-form-bottom">
                    <input type="hidden" name="search" value="{{ search_query }}">
                    <select name="page_size">
                        <option value="20" {% if pagination.page_size == 20 %}selected{% endif %}>{{ _('20/page') }}</option>
                        <option value="50" {% if pagination.page_size == 50 %}selected{% endif %}>{{ _('50/page') }}</option>
                        <option value="100" {% if pagination.page_size == 100 %}selected{% endif %}>{{ _('100/page') }}</option>
                    </select>
                    {% if pagination.page > 1 %}<a href="?search={{ search_query }}&page={{ pagination.page - 1 }}&page_size={{ pagination.page_size }}" class="button button-link pagination-link">{{ _('Previous') }}</a>{% endif %}
                    <input type="number" name="page" id="page-jump-input-bottom" class="page-jump-input" value="{{ pagination.page }}" min="1" max="{{ pagination.total_pages }}">
                    <button type="button" class="button" data-action="jump-to-page-bottom">{{ _('Go') }}</button>
                    {% if pagination.page < pagination.total_pages %}<a href="?search={{ search_query }}&page={{ pagination.page + 1 }}&page_size={{ pagination.page_size }}" class="button button-link pagination-link">{{ _('Next') }}</a>{% endif %}
                </form>
            </div>
        </div>
        <!-- Anx Library Section -->
        <div class="library" id="anx-library">
            <div class="library-header">
                <h2>{{ _('Anx Library') }}</h2>
                <div class="header-actions">
                    {% if not (disable_normal_user_upload and g.user.role == 'user') %}
                    <button type="button" class="button-primary" data-action="show-anx-upload-modal">{{ _('Upload') }}</button>
                    {% endif %}
                </div>
            </div>
            <div id="anx-library-subheader">
                 <p class="webdav-info">{{ _('Enter the WebDAV address in the Anx Reader settings page to synchronize (username and password are your login credentials):') }} <span id="anx-webdav-url" class="webdav-url" title="{{ _('Click to copy') }}"></span></p>
            </div>
            <div class="book-list" id="anx-book-list">
                {% for book in anx_books %}
            
                <div class="book-row" data-book-id="{{ book.id }}">
                    <div class="cover-wrapper">
                        <a href="{{ url_for('main.reader_page', book_type='anx', book_id=book.id) }}" class="cover-link">
                            <div class="cover">
                                {% if book.cover_path %}<img src="{{ url_for('main.anx_cover', cover_path=book.cover_path) }}" alt="{{ book.title }}">
                                {% else %}<img src="https://via.placeholder.com/100x150.png?text=No+Cover" alt="No Cover">{% endif %}
                                <div class="preview-overlay">
                                    <i class="fas fa-eye"></i>
                                </div>
                            </div>
                        </a>
                        <a href="{{ url_for('chat.chat_player', book_type='anx', book_id=book.id, book_title=book.title) }}" class="button ask-ai-button"><span class="button-text">{{ _('Ask AI') }}</span></a>
                    </div>
                    <div class="info">
                        <h3>{{ book.title }}</h3>
                        <p class="author">{{ book.author }}</p>
                        <div class="extra-details">
                            {% if book.rating is not none and book.rating | string | length > 0 and book.rating|float > 0 %}<span><strong>{{ _('Rating') }}:</strong> {{ "%.1f" | format(book.rating) }}/5</span><br>{% endif %}
                            {% if book.publisher %}<span><strong>{{ _('Publisher') }}:</strong> {{ book.publisher }}</span><br>{% endif %}
                             <span><strong>{{ _('Reading Progress') }}:</strong> {% if book.reading_percentage is not none %}{{ "%.1f" | format(book.reading_percentage * 100) }}%{% else %}0.0%{% endif %}</span><br>
                             <span><strong>{{ _('Total Reading Time') }}:</strong> {{ book.formatted_reading_time }}</span><br>
                             <span><strong>{{ _('Note Count') }}:</strong> {{ book.note_count }}</span><br>
                            {% if book.create_time %}<span><strong>{{ _('Creation Time') }}:</strong> {{ book.create_time.split('T')[0] }}</span><br>{% endif %}
                            {% if book.update_time %}<span><strong>{{ _('Update Time') }}:</strong> {{ book.update_time.split('T')[0] }}</span><br>{% endif %}
                            {% if book.book_producer %}<span><strong>{{ _('Producer') }}:</strong> {{ book.book_producer }}</span><br>{% endif %}
                            {% if book.description %}<p class="description" style="margin-top: 5px;"><strong>{{ _('Description') }}:</strong> {{ book.description | truncate(150, True) }}</p>{% endif %}
                        </div>
                    </div>
                    <div class="actions">
                        <div class="actions-main">
                            <button class="button" data-action="download-anx" data-id="{{ book.id }}"><span class="button-text">{{ _('Download') }}</span></button>
                            {% if not (disable_normal_user_upload and g.user.role == 'user') %}
                            <button class="button button-secondary" data-action="push-anx-to-calibre" data-id="{{ book.id }}"><span class="button-text">{{ _('Calibre') }}</span></button>
                            {% endif %}
                            <button class="button edit-button" data-action="edit-anx" data-id="{{ book.id }}"><span class="button-text">{{ _('Edit') }}</span></button>
                            <button class="button button-danger" data-action="delete-anx" data-id="{{ book.id }}"><span class="button-text">{{ _('Delete') }}</span></button>
                        </div>
                        <div class="actions-full-width">
                             <button class="button" data-action="generate-audiobook" data-library="anx" data-id="{{ book.id }}"><span class="button-text">{{ _('Generate Audiobook') }}</span></button>
                        </div>
                    </div>
                </div>
                {% else %}

                <p>{{ _('No books in Anx library.') }}</p>
                {% endfor %}
            </div>
        </div>

    </div>
</div>

<!-- Modals -->
<div id="uploadModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>{{ _('Upload Books') }}</h2>
            <button class="close-button" data-action="close-modal">&times;</button>
        </div>
         <div class="modal-body">
            <form id="uploadForm" method="post" enctype="multipart/form-data">
                <div class="form-group">
                    <label for="book-upload-input">{{ _('Select files:') }}</label>
                    <input id="book-upload-input" type="file" name="books" required multiple>
                </div>
                <div id="upload-progress-container" class="upload-progress-container"></div>
                <div class="modal-footer">
                     <button type="button" class="button" data-action="close-modal">{{ _('Cancel') }}</button>
                    <button type="submit" class="button-primary">{{ _('Upload') }}</button>
                    <button type="button" id="upload-done-button" class="button-primary" style="display: none;">{{ _('Done') }}</button>
                </div>
            </form>
        </div>
    </div>
</div>
<div id="editBookModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 id="edit-modal-title">{{ _('Edit Book Information') }}</h2>
            <button class="close-button" data-action="close-modal">&times;</button>
        </div>
        <div class="modal-body">
            <form id="editBookForm"></form>
        </div>
        <div class="modal-footer">
            <button type="button" class="button" data-action="close-modal">{{ _('Cancel') }}</button>
            <button type="button" class="button-primary" data-action="save-changes"><span class="button-text">{{ _('Save') }}</span></button>
        </div>
    </div>
</div>
<div id="anxUploadModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>{{ _('Upload Books to Anx Library') }}</h2>
            <button class="close-button" data-action="close-modal">&times;</button>
        </div>
         <div class="modal-body">
            <form id="anxUploadForm" method="post" enctype="multipart/form-data">
                <div class="form-group">
                    <label for="anx-book-upload-input">{{ _('Select files:') }}</label>
                    <input id="anx-book-upload-input" type="file" name="books" required multiple accept=".epub,.mobi,.azw3,.fb2,.txt,.pdf">
                </div>
                <div id="anx-upload-progress-container" class="upload-progress-container"></div>
                <div class="modal-footer">
                     <button type="button" class="button" data-action="close-modal">{{ _('Cancel') }}</button>
                    <button type="submit" class="button-primary">{{ _('Upload') }}</button>
                    <button type="button" id="anx-upload-done-button" class="button-primary" style="display: none;">{{ _('Done') }}</button>
                </div>
            </form>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script type="module" src="{{ url_for('static', filename='js/index.js') }}"></script>
{% endblock %}