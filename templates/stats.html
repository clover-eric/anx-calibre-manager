{% extends 'base.html' %}

{% block title %}{{ _('%(username)s\'s Reading Statistics', username=user.username) }}{% endblock %}

{% block head_extra %}
  <script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
  <script src="https://unpkg.com/@popperjs/core@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/cal-heatmap@4.2.2/dist/cal-heatmap.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/cal-heatmap@4.2.2/dist/plugins/Tooltip.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/utc.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1/locale/de.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1/locale/es.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1/locale/fr.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1/locale/zh-cn.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1/locale/zh-tw.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cal-heatmap@4.2.2/dist/cal-heatmap.css">
  <style>
    .stats-summary {
      display: flex;
      flex-wrap: nowrap;
      justify-content: space-around;
      gap: 1rem;
      margin: 1.5rem 0;
      padding: 0.75rem;
      background-color: var(--bs-tertiary-bg);
      border-radius: .5rem;
      overflow-x: auto;
    }
    .stat-item {
      display: flex;
      flex-direction: column; /* Vertical layout */
      align-items: center;
      gap: .25rem; /* Tighter gap */
      flex-shrink: 0;
      text-align: center;
    }
    .stat-item .label {
      font-size: .75rem;
      color: var(--bs-secondary-color);
      white-space: nowrap;
    }
    .stat-item .icon {
      width: 22px;
      height: 22px;
      fill: var(--text-color);
      margin: .25rem 0;
    }
    .stat-item .value {
      font-weight: 500;
      font-size: 1rem;
      white-space: nowrap;
    }
  </style>
{% endblock %}

{% block content %}
  <div class="stats-container">
    <h1 class="my-4">{{ _('%(username)s\'s Reading Statistics', username=user.username) }}</h1>

    <div class="stats-summary">
      <div class="stat-item">
        <div class="label">{{ _('Today') }}</div>
        <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2C17.52 2 22 6.48 22 12S17.52 22 12 22 2 17.52 2 12 6.48 2 12 2zm0 1.5C7.31 3.5 3.5 7.31 3.5 12s3.81 8.5 8.5 8.5 8.5-3.81 8.5-8.5S16.69 3.5 12 3.5zm-1.25 4.25h2.5v5.5h-2.5v-5.5zm0 6.5h2.5v2.5h-2.5v-2.5z"/></svg>
        <div class="value">{{ summary_stats.today }}</div>
      </div>
      <div class="stat-item">
        <div class="label">{{ _('This Week') }}</div>
        <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 3h-1V1h-2v2H7V1H5v2H4c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 18H4V8h16v13zM4 6V5h16v1H4z"/></svg>
        <div class="value">{{ summary_stats.this_week }}</div>
      </div>
      <div class="stat-item">
        <div class="label">{{ _('This Month') }}</div>
        <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 3h-1V1h-2v2H7V1H5v2H4c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 18H4V8h16v13z"/></svg>
        <div class="value">{{ summary_stats.this_month }}</div>
      </div>
      <div class="stat-item">
        <div class="label">{{ _('This Year') }}</div>
        <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M5 4h14v2H5zm14 14H5V8h14z" opacity=".3"/><path d="M19 3h-1V1h-2v2H8V1H6v2H5c-1.11 0-1.99.9-1.99 2L3 19c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V8h14v11zM5 6h14V4H5v2z"/></svg>
        <div class="value">{{ summary_stats.this_year }}</div>
      </div>
      <div class="stat-item">
        <div class="label">{{ _('Total') }}</div>
        <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8z"/><path d="M11 7h2v2h-2zm0 4h2v6h-2z"/></svg>
        <div class="value">{{ summary_stats.total }}</div>
      </div>
    </div>

    <h2 class="my-4">{{ _('Reading Heatmap (Last 365 Days)') }}</h2>
    <div id="cal-heatmap-container"
         data-heatmap-data='{{ heatmap_data | tojson | safe }}'
         data-locale="{{ get_locale() }}"
         data-start-date="{{ heatmap_start_date }}">
      <div id="cal-heatmap"></div>
    </div>

    <hr class="my-5">

    <div class="book-lists">
      <div class="book-list-column">
        <h2>{{ _('Reading Books') }}</h2>
        {% for book in reading_books %}
          <div class="book-row">
            <div class="cover">
              <img src="{{ url_for('main.anx_cover_public', username=user.username, cover_path=book.cover_path) }}" alt="Cover for {{ book.title }}">
            </div>
            <div class="info">
              <h3>{{ book.title }}</h3>
              <p class="author">{{ _('Author') }}: {{ book.author }}</p>
              <p class="extra-details">
                {{ _('Rating') }}: {{ book.rating if book.rating > 0 else _('Not rated') }} <br>
                {{ _('Total Reading Time') }}: {{ book.formatted_reading_time }}
              </p>
              <p class="description" style="white-space: pre-wrap;">{{ book.description }}</p>
              {% set progress_percent = book.reading_percentage * 100 %}
              <div class="progress mt-2">
                <div class="progress-bar dynamic-progress" role="progressbar" data-progress="{{ progress_percent }}" aria-valuenow="{{ progress_percent }}" aria-valuemin="0" aria-valuemax="100">{{ "%.2f"|format(progress_percent) }}%</div>
              </div>
            </div>
          </div>
        {% else %}
          <p>{{ _('No books currently being read.') }}</p>
        {% endfor %}
      </div>
      <div class="book-list-column">
        <h2>{{ _('Finished Books') }}</h2>
        {% for book in finished_books %}
          <div class="book-row">
            <div class="cover">
              <img src="{{ url_for('main.anx_cover_public', username=user.username, cover_path=book.cover_path) }}" alt="Cover for {{ book.title }}">
            </div>
            <div class="info">
              <h3>{{ book.title }}</h3>
              <p class="author">{{ _('Author') }}: {{ book.author }}</p>
              <p class="extra-details">
                {{ _('Rating') }}: {{ book.rating if book.rating > 0 else _('Not rated') }} <br>
                {{ _('Total Reading Time') }}: {{ book.formatted_reading_time }}
              </p>
              <p class="description" style="white-space: pre-wrap;">{{ book.description }}</p>
              <p><strong>{{ _('Finished!') }}</strong></p>
            </div>
          </div>
        {% else %}
          <p>{{ _('No finished books yet.') }}</p>
        {% endfor %}
      </div>
    </div>
  </div>
{% endblock %}

{% block scripts %}
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // --- Dynamically set progress bar widths to avoid linter errors ---
      document.querySelectorAll('.dynamic-progress').forEach(bar => {
        const progress = bar.getAttribute('data-progress');
        if (progress) {
          bar.style.width = progress + '%';
        }
      });

      const container = document.getElementById('cal-heatmap-container');
      const heatmapData = JSON.parse(container.dataset.heatmapData);
      const currentLocale = container.dataset.locale;
      const startDate = container.dataset.startDate;

      dayjs.extend(window.dayjs_plugin_utc);

      const localeMap = {
        'zh_Hans': 'zh-cn',
        'zh_Hant': 'zh-tw',
        'es': 'es',
        'fr': 'fr',
        'de': 'de'
      };
      const dayjsLocale = localeMap[currentLocale] || 'en';
      dayjs.locale(dayjsLocale);

      const cal = new CalHeatmap();

      cal.paint({
        itemSelector: '#cal-heatmap',
        data: {
          source: heatmapData,
          x: 'date',
          y: 'value'
        },
        date: {
          start: new Date(startDate)
        },
        range: 12,
        domain: {
          type: 'month',
          label: {
            text: (timestamp) => dayjs(timestamp).format('MMMM'),
            textAlign: 'start',
            position: 'bottom'
          }
        },
        subDomain: {
          type: 'ghDay'
        },
        scale: {
          color: {
            type: 'linear',
            range: ['#a6e3a1', '#1e662a'],
            domain: [0, 7200]
          }
        }
      },
      [
        [Tooltip, {
          text: function (date, value, dayjsDate) {
            const entry = heatmapData.find(d => d.date === dayjsDate.format('YYYY-MM-DD'));
            return (entry ? entry.title : (dayjsDate.format('YYYY-MM-DD') + ': 无阅读记录'));
          }
        }]
      ]).then(() => {
        setTimeout(() => {
          if (container.scrollWidth > container.clientWidth) {
            container.scrollLeft = container.scrollWidth;
          }
        }, 0);
      });
    });

    window.onload = function() {
      var body = document.body;
      var style = window.getComputedStyle(body);
      var height = body.offsetHeight + parseInt(style.marginTop) + parseInt(style.marginBottom);
      window.parent.postMessage({
        frameHeight: height
      }, '*');
    };
  </script>
{% endblock %}