{% extends 'base.html' %}

{% block title %}{{ _('%(username)s\'s Reading Statistics', username=user.username) }}{% endblock %}

{% block head_extra %}
  <script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
  <script src="https://unpkg.com/@popperjs/core@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/cal-heatmap@4.2.2/dist/cal-heatmap.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/cal-heatmap@4.2.2/dist/plugins/Tooltip.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/utc.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1/locale/de.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1/locale/es.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1/locale/fr.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1/locale/zh-cn.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1/locale/zh-tw.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cal-heatmap@4.2.2/dist/cal-heatmap.css">
{% endblock %}

{% block content %}
  <div class="stats-container">
    <h1 class="my-4">{{ _('%(username)s\'s Reading Statistics', username=user.username) }}</h1>

    <h2 class="my-4">{{ _('Reading Heatmap (Last 365 Days)') }}</h2>
    <div id="cal-heatmap-container"
         data-heatmap-data='{{ heatmap_data | tojson | safe }}'
         data-locale="{{ get_locale() }}"
         data-start-date="{{ heatmap_start_date }}">
      <div id="cal-heatmap"></div>
    </div>

    <hr class="my-5">

    <div class="book-lists">
      <div class="book-list-column">
        <h2>{{ _('Reading Books') }}</h2>
        {% for book in reading_books %}
          <div class="book-row">
            <div class="cover">
              <img src="{{ url_for('main.anx_cover_public', username=user.username, cover_path=book.cover_path) }}" alt="Cover for {{ book.title }}">
            </div>
            <div class="info">
              <h3>{{ book.title }}</h3>
              <p class="author">{{ _('Author') }}: {{ book.author }}</p>
              <p class="extra-details">
                {{ _('Rating') }}: {{ book.rating if book.rating > 0 else _('Not rated') }} <br>
                {{ _('Total Reading Time') }}: {{ book.formatted_reading_time }}
              </p>
              <p class="description" style="white-space: pre-wrap;">{{ book.description | truncate(150) }}</p>
              <div class="progress mt-2">
                <div class="progress-bar" role="progressbar" style="width: {{ book.reading_percentage * 100 }}%;" aria-valuenow="{{ book.reading_percentage * 100 }}" aria-valuemin="0" aria-valuemax="100">{{ "%.2f"|format(book.reading_percentage * 100) }}%</div>
              </div>
            </div>
          </div>
        {% else %}
          <p>{{ _('No books currently being read.') }}</p>
        {% endfor %}
      </div>
      <div class="book-list-column">
        <h2>{{ _('Finished Books') }}</h2>
        {% for book in finished_books %}
          <div class="book-row">
            <div class="cover">
              <img src="{{ url_for('main.anx_cover_public', username=user.username, cover_path=book.cover_path) }}" alt="Cover for {{ book.title }}">
            </div>
            <div class="info">
              <h3>{{ book.title }}</h3>
              <p class="author">{{ _('Author') }}: {{ book.author }}</p>
              <p class="extra-details">
                {{ _('Rating') }}: {{ book.rating if book.rating > 0 else _('Not rated') }} <br>
                {{ _('Total Reading Time') }}: {{ book.formatted_reading_time }}
              </p>
              <p class="description" style="white-space: pre-wrap;">{{ book.description | truncate(150) }}</p>
              <p><strong>{{ _('Finished!') }}</strong></p>
            </div>
          </div>
        {% else %}
          <p>{{ _('No finished books yet.') }}</p>
        {% endfor %}
      </div>
    </div>
  </div>
{% endblock %}

{% block scripts %}
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const container = document.getElementById('cal-heatmap-container');
      const heatmapData = JSON.parse(container.dataset.heatmapData);
      const currentLocale = container.dataset.locale;
      const startDate = container.dataset.startDate;

      dayjs.extend(window.dayjs_plugin_utc);

      const localeMap = {
        'zh_Hans': 'zh-cn',
        'zh_Hant': 'zh-tw',
        'es': 'es',
        'fr': 'fr',
        'de': 'de'
      };
      const dayjsLocale = localeMap[currentLocale] || 'en';
      dayjs.locale(dayjsLocale);

      const cal = new CalHeatmap();

      cal.paint({
        itemSelector: '#cal-heatmap',
        data: {
          source: heatmapData,
          x: 'date',
          y: 'value'
        },
        date: {
          start: new Date(startDate)
        },
        range: 12,
        domain: {
          type: 'month',
          label: {
            text: (timestamp) => dayjs(timestamp).format('MMMM'),
            textAlign: 'start',
            position: 'bottom'
          }
        },
        subDomain: {
          type: 'ghDay'
        },
        scale: {
          color: {
            type: 'linear',
            range: ['#a6e3a1', '#1e662a'],
            domain: [0, 7200]
          }
        }
      },
      [
        [Tooltip, {
          text: function (date, value, dayjsDate) {
            const entry = heatmapData.find(d => d.date === dayjsDate.format('YYYY-MM-DD'));
            return (entry ? entry.title : (dayjsDate.format('YYYY-MM-DD') + ': 无阅读记录'));
          }
        }]
      ]).then(() => {
        setTimeout(() => {
          if (container.scrollWidth > container.clientWidth) {
            container.scrollLeft = container.scrollWidth;
          }
        }, 0);
      });
    });

    window.onload = function() {
      var body = document.body;
      var style = window.getComputedStyle(body);
      var height = body.offsetHeight + parseInt(style.marginTop) + parseInt(style.marginBottom);
      window.parent.postMessage({
        frameHeight: height
      }, '*');
    };
  </script>
{% endblock %}