{% extends "base.html" %}

{% block title %}{{ _('Settings') }} - Anx Calibre Manager{% endblock %}

{% block head_extra %}
{% endblock %}

{% block content %}
<div class="settings-container">
    <div class="loading-overlay" id="settings-loading-overlay" style="display: flex;">
        <div class="spinner"></div>
    </div>
    <h2>{{ _('Settings') }}</h2>

    <div class="tabs">
        <div class="tab-link active" onclick="openTab(event, 'userSettings')">{{ _('User Settings') }}</div>
        <div class="tab-link" onclick="openTab(event, 'mcpSettings')">{{ _('MCP Settings') }}</div>
        <div class="tab-link" onclick="openTab(event, 'koreaderSettings')">{{ _('Koreader Sync Settings') }}</div>
        {% if g.user and g.user.role == 'admin' %}
        <div class="tab-link" onclick="openTab(event, 'globalSettings')">{{ _('Global Settings') }}</div>
        <div class="tab-link" onclick="openTab(event, 'userManagement')">{{ _('User Management') }}</div>
        <div class="tab-link" onclick="openTab(event, 'inviteCodeManagement')">{{ _('Invite Code Management') }}</div>
        {% endif %}
    </div>

    <!-- 用户设置 -->
    <div id="userSettings" class="tab-content page-transition active">
        <form id="userSettingsForm" onsubmit="saveUserSettings(event)">
            <h3>{{ _('Profile') }}</h3>
            <div class="form-group">
                <label>{{ _('Username') }}</label>
                <input type="text" id="username_display" value="{{ g.user.username }}" disabled>
            </div>
            <div class="form-group">
                <label for="new_password">{{ _('Change Password') }}</label>
                <input type="password" id="new_password" name="new_password" placeholder="{{ _('Leave blank to keep unchanged') }}">
            </div>

            <h3>{{ _('Appearance') }}</h3>
            <div class="form-group">
                <label for="theme">{{ _('Theme') }}</label>
                <select id="theme" name="theme">
                    <option value="auto">{{ _('Auto (Follow system)') }}</option>
                    <option value="light">{{ _('Light Mode') }}</option>
                    <option value="dark">{{ _('Dark Mode') }}</option>
                </select>
            </div>

            <h3>{{ _('Push Settings') }}</h3>
             <div class="form-group">
                <label for="kindle_email">{{ _('Kindle Email Address') }}</label>
                <input type="email" id="kindle_email" name="kindle_email">
                <small id="smtp_from_address_tip"></small>
            </div>
            <div class="form-group">
                <label for="send_format_priority">{{ _('Format Priority') }}</label>
                <input type="text" id="send_format_priority" name="send_format_priority">
                <small>{{ _('When downloading or pushing to Kindle / ANX library, available formats will be searched in this priority order. Use commas to separate, e.g., epub, mobi, pdf, azw3') }}</small>
            </div>
            <div class="form-group">
                <input type="checkbox" id="force_epub_conversion" name="force_epub_conversion" value="true" style="width: auto; margin-right: 5px;">
                <label for="force_epub_conversion" style="display: inline;">{{ _('Force EPUB Conversion') }}</label></br>
                <small>{{ _('If enabled, will always try to convert the book to an optimized EPUB format when downloading or pushing to the ANX library, instead of sending the original format.') }}</small>
            </div>
            <h3>{{ _('Statistics Settings') }}</h3>
            <div class="form-group">
                <input type="checkbox" id="stats_enabled" name="stats_enabled" value="true" style="width: auto; margin-right: 5px;">
                <label for="stats_enabled" style="display: inline;">{{ _('Enable Reading Statistics Page') }}</label></br>
                <small>{{ _('Allows you to view your reading statistics after logging in.') }}</small>
            </div>
            <div class="form-group">
                <input type="checkbox" id="stats_public" name="stats_public" value="true" style="width: auto; margin-right: 5px;">
                <label for="stats_public" style="display: inline;">{{ _('Make Statistics Page Public') }}</label></br>
                <small>{{ _('If enabled, your statistics page will be publicly accessible without needing to log in.') }}</small>
            </div>
            <div id="stats_url_container" style="display: none;" class="mcp-docs">
                <h4>{{ _('Your Statistics Page URL') }}</h4>
                <p><a id="stats_url" href="#" target="_blank"></a></p>
            </div>
            
            <h3>{{ _('Two-Factor Authentication (2FA)') }}</h3>
            <div id="2fa_status_container"></div>
            <div id="2fa_setup_container" style="display:none;">
                <p>{{ _('Please use your authenticator app to scan this QR code:') }}</p>
                <div id="qr_code_container"></div>
                <p>{{ _('Or manually enter the key:') }} <code id="otp_secret_key"></code></p>
                <div class="form-group">
                    <label for="otp_code">{{ _('Verification Code') }}</label>
                    <input type="text" id="otp_code" name="otp_code" placeholder="{{ _('Enter the 6-digit code to complete setup') }}" autocomplete="off">
                </div>
                <button type="button" class="button-primary" onclick="verify2FA()">{{ _('Verify and Enable') }}</button>
                <button type="button" class="button" onclick="cancel2FASetup()">{{ _('Cancel') }}</button>
            </div>

            <div style="text-align: right; margin-top: 2rem;">
                <button type="submit" class="button-primary">{{ _('Save User Settings') }}</button>
            </div>
        </form>
    </div>

    <!-- MCP 设置 -->
    <div id="mcpSettings" class="tab-content page-transition">
        <h3>{{ _('MCP API Tokens') }}</h3>
        <p>{{ _('You can use these tokens to interact with your library via the MCP protocol.') }}</p>
        <div id="mcp-token-list">
            <!-- Tokens will be loaded here by JavaScript -->
        </div>
        <div style="text-align: right; margin-top: 1rem;">
            <button class="button-primary" onclick="generateMcpToken()">{{ _('Generate New Token') }}</button>
        </div>

        <div class="mcp-docs">
            <h4>{{ _('MCP Endpoint') }}</h4>
            <p><code>{{ request.host_url.rstrip('/') }}/mcp?token=YOUR_TOKEN</code></p>
            <h4>{{ _('Authentication') }}</h4>
            <p>{{ _('Authenticate by appending the `?token=YOUR_TOKEN` parameter to the URL.') }}</p>
            <h4>{{ _('Available Tools') }}</h4>
            <ul>
                <li><strong>search_calibre_books</strong>: {{ _('Search Calibre books. Parameters: `search_expression` (str), `limit` (int, default 20)') }}</li>
                <li><strong>get_recent_calibre_books</strong>: {{ _('Get recent Calibre books. Parameters: `limit` (int, default 20)') }}</li>
                <li><strong>get_calibre_book_details</strong>: {{ _('Get Calibre book details. Parameters: `book_id` (int)') }}</li>
                <li><strong>get_recent_anx_books</strong>: {{ _('Get recent Anx books. Parameters: `limit` (int, default 20)') }}</li>
                <li><strong>get_anx_book_details</strong>: {{ _('Get Anx book details. Parameters: `book_id` (int)') }}</li>
                <li><strong>push_calibre_book_to_anx</strong>: {{ _('Push Calibre book to Anx. Parameters: `book_id` (int)') }}</li>
                <li><strong>send_calibre_book_to_kindle</strong>: {{ _('Send Calibre book to Kindle. Parameters: `book_id` (int)') }}</li>
                <li><strong>get_calibre_epub_table_of_contents</strong>: {{ _('Get table of contents for a Calibre book. Params: `book_id` (int)') }}</li>
                <li><strong>get_calibre_epub_chapter_content</strong>: {{ _('Get chapter content for a Calibre book. Params: `book_id` (int), `chapter_number` (int)') }}</li>
                <li><strong>get_anx_epub_table_of_contents</strong>: {{ _('Get table of contents for an Anx book. Params: `book_id` (int)') }}</li>
                <li><strong>get_anx_epub_chapter_content</strong>: {{ _('Get chapter content for an Anx book. Params: `book_id` (int), `chapter_number` (int)') }}</li>
            </ul>
        </div>
    </div>

    <!-- Koreader 同步设置 -->
    <div id="koreaderSettings" class="tab-content page-transition">
        <h3>{{ _('KOReader Sync Settings') }}</h3>
        <div class="mcp-docs">
            <h4>{{ _('Step 1: Configure WebDAV Cloud Storage') }}</h4>
            <ol>
                <li>{{ _('In KOReader, go to `Cloud storage` -> `Add new cloud storage`.') }}</li>
                <li>{{ _('Select `WebDAV`.') }}</li>
                <li><strong>{{ _('Server address') }}</strong>: {{ _('Fill in the address below, and <strong>ensure the path ends with a `/`</strong>.') }}
                    <p><code id="koreader-webdav-url" class="webdav-url" title="{{ _('Click to copy') }}"></code></p>
                </li>
                <li><strong>{{ _('Username') }}</strong>: <code>{{ g.user.username }}</code></li>
                <li><strong>{{ _('Password') }}</strong>: {{ _('Your Anx Calibre Manager login password.') }}</li>
                <li><strong>{{ _('Folder') }}</strong>: <code>/anx/data/file</code></li>
                <li>{{ _('Click `Connect` and save. You should now be able to see your Anx library in KOReader\'s file browser.') }}</li>
            </ol>

            <h4>{{ _('Step 2: Install and Configure the Sync Plugin') }}</h4>
            <ol>
                <li>
                    <strong>{{ _('Download Plugin') }}</strong>: {{ _('Click the button below to download the plugin zip file.') }}
                    <div style="margin-top: 1rem; margin-bottom: 1rem;">
                        <button onclick="location.href='{{ url_for('calibre.download_koreader_plugin') }}'" class="button-primary">{{ _('Download KOReader Plugin (.zip)') }}</button>
                    </div>
                </li>
                <li><strong>{{ _('Install Plugin') }}</strong>: {{ _('Unzip the downloaded `.zip` file, and you will get a folder named `anx-calibre-manager-koreader-plugin.koplugin`. Copy this <strong>entire folder</strong> to the `koreader/plugins/` directory on your KOReader device.') }}</li>
                <li><strong>{{ _('Restart KOReader') }}</strong>: {{ _('Completely close and reopen the KOReader application to load the new plugin.') }}</li>
                <li><strong>{{ _('Configure Sync Server') }}</strong>:
                    <ul>
                        <li><strong>{{ _('Important') }}</strong>: {{ _('First, please open and start reading a book via the WebDAV set up in the previous step. The plugin menu will <strong>only appear in the reading interface</strong>.') }}</li>
                        <li>{{ _('In the reading interface, go to `Tools (wrench icon)` -> `Next page` -> `More tools` -> `ANX Calibre Manager`.') }}</li>
                        <li>{{ _('Select `Custom sync server`.') }}</li>
                        <li><strong>{{ _('Custom sync server address') }}</strong>: <code>{{ request.host_url.rstrip('/') }}/koreader</code></li>
                        <li>{{ _('Return to the previous menu, select `Login`, and enter your Anx Calibre Manager username and password.') }}</li>
                    </ul>
                </li>
            </ol>
            <p>{{ _('Once configured, the plugin will automatically or manually sync your reading progress and time. You can adjust settings like sync frequency in the plugin menu.') }}</p><br>
            <p><strong>({{ _('Note: Only supports epub book synchronization') }})</strong></p>
        </div>
    </div>

    <!-- 全局设置 (仅限管理员) -->
    {% if g.user and g.user.role == 'admin' %}
    <div id="globalSettings" class="tab-content page-transition">
        <form id="globalSettingsForm" onsubmit="saveGlobalSettings(event)">
            <h3>{{ _('Calibre Connection') }}</h3>
            <div class="form-group">
                <label for="CALIBRE_URL">{{ _('Calibre Server URL') }}</label>
                <input type="url" id="CALIBRE_URL" name="CALIBRE_URL">
            </div>
            <div class="form-group">
                <label for="CALIBRE_USERNAME">{{ _('Calibre Username') }}</label>
                <input type="text" id="CALIBRE_USERNAME" name="CALIBRE_USERNAME">
            </div>
            <div class="form-group">
                <label for="CALIBRE_PASSWORD">{{ _('Calibre Password') }}</label>
                <input type="password" id="CALIBRE_PASSWORD" name="CALIBRE_PASSWORD" placeholder="{{ _('Leave blank to keep unchanged') }}">
            </div>
            <div class="setting-item">
                <label for="CALIBRE_DEFAULT_LIBRARY_ID">{{ _('Default Calibre Library ID') }}</label>
                <input type="text" id="CALIBRE_DEFAULT_LIBRARY_ID" name="CALIBRE_DEFAULT_LIBRARY_ID" placeholder="Calibre_Library">
                <small>{{ _('The default Calibre library ID for browsing, searching, and uploading books. Usually \'Calibre_Library\'.') }}</small>
            </div>
            <div class="form-group">
                <input type="checkbox" id="CALIBRE_ADD_DUPLICATES" name="CALIBRE_ADD_DUPLICATES" value="true" style="width: auto; margin-right: 5px;">
                <label for="CALIBRE_ADD_DUPLICATES" style="display: inline;">{{ _('Allow uploading duplicate books') }}</label></br>
                <small>{{ _('If enabled, Calibre will add the book as a new copy even if it detects a duplicate.') }}</small>
            </div>
            <h3>{{ _('Path Settings') }}</h3>
            <div class="form-group">
                <label for="WEBDAV_ROOT">{{ _('WebDAV Root Path') }}</label>
                <input type="text" id="WEBDAV_ROOT" name="WEBDAV_ROOT">
                <small>{{ _('This is the base path for storing all user Anx libraries. User folders will be automatically created under this path (e.g., /webdav/username).') }}</small>
            </div>

            <h3>{{ _('Default Settings') }}</h3>
            <div class="form-group">
                <label for="DEFAULT_FORMAT_PRIORITY">{{ _('Default Format Priority for New Users') }}</label>
                <input type="text" id="DEFAULT_FORMAT_PRIORITY" name="DEFAULT_FORMAT_PRIORITY">
                <small>{{ _('Default format priority for new users, separated by commas, e.g., azw3,mobi,epub') }}</small>
            </div>

            <h3>{{ _('SMTP Settings (for Send to Kindle)') }}</h3>
            <div class="form-group">
                <label for="SMTP_SERVER">{{ _('SMTP Server') }}</label>
                <input type="text" id="SMTP_SERVER" name="SMTP_SERVER">
            </div>
            <div class="form-group">
                <label for="SMTP_PORT">{{ _('SMTP Port') }}</label>
                <input type="number" id="SMTP_PORT" name="SMTP_PORT">
            </div>
            <div class="form-group">
                <label for="SMTP_USERNAME">{{ _('SMTP Username (usually your email)') }}</label>
                <input type="text" id="SMTP_USERNAME" name="SMTP_USERNAME">
            </div>
            <div class="form-group">
                <label for="SMTP_PASSWORD">{{ _('SMTP Password') }}</label>
                <input type="password" id="SMTP_PASSWORD" name="SMTP_PASSWORD" autocomplete="new-password">
            </div>
            <div class="form-group">
                <label for="SMTP_ENCRYPTION">{{ _('Encryption Method') }}</label>
                <select id="SMTP_ENCRYPTION" name="SMTP_ENCRYPTION">
                    <option value="none">{{ _('None') }}</option>
                    <option value="starttls">{{ _('STARTTLS') }}</option>
                    <option value="ssl">{{ _('SSL/TLS') }}</option>
                </select>
                <small>{{ _('SSL/TLS is usually used for port 465, STARTTLS is usually used for port 587.') }}</small>
            </div>

            <h3>{{ _('Security') }}</h3>
            <div class="form-group">
                <label for="LOGIN_MAX_ATTEMPTS">{{ _('Login Failure Lock Threshold') }}</label>
                <input type="number" id="LOGIN_MAX_ATTEMPTS" name="LOGIN_MAX_ATTEMPTS" min="0">
                <small>{{ _('Set to 0 to disable this feature.') }}</small>
            </div>
            <div class="form-group">
                <label for="SESSION_LIFETIME_DAYS">{{ _('Session Lifetime (days)') }}</label>
                <input type="number" id="SESSION_LIFETIME_DAYS" name="SESSION_LIFETIME_DAYS" min="1">
                <small>{{ _('The number of days a user\'s session remains valid after logging in.') }}</small>
            </div>

            <div class="form-group">
                <label for="test_email_address">{{ _('Test Inbox') }}</label>
                <input type="email" id="test_email_address" name="test_email_address" placeholder="{{ _('Enter an email address to receive a test email') }}">
            </div>
            <div style="text-align: right; margin-top: 2rem;">
                <button type="button" class="button" onclick="testSmtpSettings()">{{ _('Send Test Email') }}</button>
                <button type="submit" class="button-primary">{{ _('Save Global Settings') }}</button>
            </div>
        </form>
    </div>

    <!-- 用户管理 (仅限管理员) -->
    <div id="userManagement" class="tab-content page-transition">
        <form id="userForm" onsubmit="handleUserFormSubmit(event)" class="form-container" style="margin-bottom: 2rem;">
            <input type="hidden" id="user_id" name="user_id">
            <h3><span id="formTitle">{{ _('Add') }}</span> {{ _('New User') }}</h3>
            <div class="form-group">
                <label for="username">{{ _('Username') }}</label>
                <input type="text" id="username" name="username" required>
            </div>
            <div class="form-group">
                <label for="password">{{ _('Password') }}</label>
                <input type="password" id="password" name="password">
                <small>{{ _('Leave blank to not change the existing user\'s password.') }}</small>
            </div>
            <div class="form-group">
                <label for="role">{{ _('Role') }}</label>
                <select id="role" name="role">
                    <option value="user">{{ _('Normal User') }}</option>
                    <option value="maintainer">{{ _('Calibre Library Maintainer') }}</option>
                    <option value="admin">{{ _('Administrator') }}</option>
                </select>
            </div>
            <div style="text-align: right;">
                <button type="submit" class="button-primary">{{ _('Save') }}</button>
                <button type="button" class="button" onclick="resetUserForm()">{{ _('Cancel') }}</button>
            </div>
        </form>

        <h3>{{ _('Existing Users') }}</h3>
        <table id="userTable">
            <thead>
                <tr>
                    <th>{{ _('ID') }}</th>
                    <th>{{ _('Username') }}</th>
                    <th>{{ _('Role') }}</th>
                    <th>{{ _('Actions') }}</th>
                </tr>
            </thead>
            <tbody>
                <!-- 用户数据将由 JavaScript 动态填充 -->
            </tbody>
        </table>
    </div>

    <!-- 邀请码管理 (仅限管理员) -->
    <div id="inviteCodeManagement" class="tab-content page-transition">
        <form id="inviteCodeForm" onsubmit="generateInviteCode(event)" class="form-container" style="margin-bottom: 2rem;">
            <h3>{{ _('Generate New Invite Code') }}</h3>
            <div class="form-group">
                <label for="custom_code">{{ _('Custom Invite Code') }}</label>
                <input type="text" id="custom_code" name="custom_code" placeholder="{{ _('Leave blank to auto-generate') }}">
                <small>{{ _('Custom invite code (optional). If left blank, a random code will be generated.') }}</small>
            </div>
            <div class="form-group">
                <label for="max_uses">{{ _('Maximum Uses') }}</label>
                <input type="number" id="max_uses" name="max_uses" value="1" min="1">
                <small>{{ _('How many times this invite code can be used') }}</small>
            </div>
            <div class="form-group">
                <label for="expires_hours">{{ _('Expires After (Hours)') }}</label>
                <input type="number" id="expires_hours" name="expires_hours" placeholder="{{ _('Leave blank for no expiration') }}">
                <small>{{ _('Number of hours after which this invite code will expire (optional)') }}</small>
            </div>
            <div style="text-align: right;">
                <button type="submit" class="button-primary">{{ _('Generate Invite Code') }}</button>
            </div>
        </form>

        <h3>{{ _('Existing Invite Codes') }}</h3>
        <table id="inviteCodeTable">
            <thead>
                <tr>
                    <th>{{ _('Code') }}</th>
                    <th>{{ _('Max Uses') }}</th>
                    <th>{{ _('Current Uses') }}</th>
                    <th>{{ _('Created By') }}</th>
                    <th>{{ _('Created At') }}</th>
                    <th>{{ _('Expires At') }}</th>
                    <th>{{ _('Status') }}</th>
                    <th>{{ _('Actions') }}</th>
                </tr>
            </thead>
            <tbody>
                <!-- 邀请码数据将由 JavaScript 动态填充 -->
            </tbody>
        </table>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script id="is-admin-data" type="application/json">{{ (g.user.role == 'admin') | tojson | safe }}</script>
<script id="is-maintainer-data" type="application/json">{{ g.user.is_maintainer | tojson | safe }}</script>
<script src="{{ url_for('static', filename='js/settings.js') }}"></script>
{% endblock %}