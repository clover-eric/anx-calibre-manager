{% extends "base.html" %}

{% block title %}{{ _('Settings') }} - Anx Calibre Manager{% endblock %}

{% block head_extra %}
{% endblock %}

{% block content %}
<div class="settings-container">
    <div class="loading-overlay" id="settings-loading-overlay" style="display: flex;">
        <div class="spinner"></div>
    </div>
    <h2>{{ _('Settings') }}</h2>

    <div class="tabs">
        <div class="tab-link active" onclick="openTab(event, 'userSettings')">{{ _('User Settings') }}</div>
        <div class="tab-link" onclick="openTab(event, 'mcpSettings')">{{ _('MCP Settings') }}</div>
        <div class="tab-link" onclick="openTab(event, 'koreaderSettings')">{{ _('Koreader Sync Settings') }}</div>
        {% if g.user and g.user.role == 'admin' %}
        <div class="tab-link" onclick="openTab(event, 'globalSettings')">{{ _('Global Settings') }}</div>
        <div class="tab-link" onclick="openTab(event, 'userManagement')">{{ _('User Management') }}</div>
        <div class="tab-link" onclick="openTab(event, 'inviteCodeManagement')">{{ _('Invite Code Management') }}</div>
        {% endif %}
    </div>

    <!-- 用户设置 -->
    <div id="userSettings" class="tab-content page-transition active">
        <form id="userSettingsForm" onsubmit="saveUserSettings(event)">
            <h3>{{ _('Profile') }}</h3>
            <div class="form-group">
                <label>{{ _('Username') }}</label>
                <input type="text" id="username_display" value="{{ g.user.username }}" disabled>
            </div>
            <div class="form-group">
                <label for="new_password">{{ _('Change Password') }}</label>
                <input type="password" id="new_password" name="new_password" placeholder="{{ _('Leave blank to keep unchanged') }}">
            </div>

            <h3>{{ _('Appearance') }}</h3>
            <div class="form-group">
                <label for="theme">{{ _('Theme') }}</label>
                <select id="theme" name="theme">
                    <option value="auto">{{ _('Auto (Follow system)') }}</option>
                    <option value="light">{{ _('Light Mode') }}</option>
                    <option value="dark">{{ _('Dark Mode') }}</option>
                </select>
            </div>

            <h3>{{ _('Push Settings') }}</h3>
             <div class="form-group">
                <label for="kindle_email">{{ _('Kindle Email Address') }}</label>
                <input type="email" id="kindle_email" name="kindle_email">
                <small id="smtp_from_address_tip"></small>
            </div>
            <div class="form-group">
                <label for="send_format_priority">{{ _('Format Priority') }}</label>
                <input type="text" id="send_format_priority" name="send_format_priority">
                <small>{{ _('When downloading or pushing to Kindle / ANX library, available formats will be searched in this priority order. Use commas to separate, e.g., epub, mobi, pdf, azw3') }}</small>
            </div>
            <div class="form-group">
                <input type="checkbox" id="force_epub_conversion" name="force_epub_conversion" value="true" style="width: auto; margin-right: 5px;">
                <label for="force_epub_conversion" style="display: inline;">{{ _('Force EPUB Conversion') }}</label></br>
                <small>{{ _('If enabled, will always try to convert the book to an optimized EPUB format when downloading or pushing to the ANX library, instead of sending the original format.') }}</small>
            </div>

            <h3>{{ _('Audiobook Generation Settings') }}</h3>
            <div class="form-group">
                <label for="tts_provider">{{ _('TTS Provider') }}</label>
                <select id="tts_provider" name="tts_provider">
                    <option value="edge">Edge TTS</option>
                    <option value="openai">OpenAI Compatible TTS</option>
                </select>
                <small>{{ _('The text-to-speech service provider to use.') }}</small>
            </div>
            <div class="form-group tts-setting edge-setting openai-setting">
                <label for="tts_voice">{{ _('Voice') }}</label>
                <input type="text" id="tts_voice" name="tts_voice" list="tts_voice_list" placeholder="{{ _('Select or type a voice') }}">
                <datalist id="tts_voice_list">
                    <!-- Options will be dynamically populated by JavaScript -->
                </datalist>
                <small>{{ _('The voice to use for generation. e.g., zh-CN-YunjianNeural for Edge TTS.') }}</small>
            </div>
            <div class="form-group tts-setting openai-setting" style="display: none;">
                <label for="tts_api_key">{{ _('API Key') }}</label>
                <input type="password" id="tts_api_key" name="tts_api_key" autocomplete="new-password">
                <small>{{ _('API key for the selected provider (if required).') }}</small>
            </div>
            <div class="form-group tts-setting openai-setting" style="display: none;">
                <label for="tts_base_url">{{ _('Base URL') }}</label>
                <input type="url" id="tts_base_url" name="tts_base_url">
                <small>{{ _('Custom base URL for the API (for proxies or self-hosted models).') }}</small>
            </div>
            <div class="form-group tts-setting openai-setting" style="display: none;">
                <label for="tts_model">{{ _('Model') }}</label>
                <input type="text" id="tts_model" name="tts_model">
                <small>{{ _('The specific model to use, e.g., tts-1-hd (if supported by the provider).') }}</small>
            </div>
            <div class="form-group tts-setting edge-setting openai-setting">
                <label for="tts_rate">{{ _('Rate') }}</label>
                <input type="text" id="tts_rate" name="tts_rate">
                <small>{{ _('Speaking rate. e.g., +10%% or -10%%.') }}</small>
            </div>
            <div class="form-group tts-setting edge-setting">
                <label for="tts_volume">{{ _('Volume') }}</label>
                <input type="text" id="tts_volume" name="tts_volume">
                <small>{{ _('Volume level. e.g., +10%% or -10%%.') }}</small>
            </div>
            <div class="form-group tts-setting edge-setting">
                <label for="tts_pitch">{{ _('Pitch') }}</label>
                <input type="text" id="tts_pitch" name="tts_pitch">
                <small>{{ _('Speaking pitch. e.g., +10Hz or -10Hz.') }}</small>
            </div>

            <h3>{{ _('LLM Provider Settings') }}</h3>
            <div class="form-group">
                <label for="llm_provider">{{ _('LLM Provider') }}</label>
                <select id="llm_provider" name="llm_provider">
                    <option value="openai">OpenAI Compatible</option>
                </select>
                <small>{{ _('The Large Language Model provider to use for MCP.') }}</small>
            </div>
            <div class="form-group llm-setting openai-llm-setting">
                <label for="llm_base_url">{{ _('Base URL') }}</label>
                <input type="url" id="llm_base_url" name="llm_base_url">
                <small>{{ _('Custom base URL for the API (e.g., for proxies or self-hosted models).') }}</small>
            </div>
            <div class="form-group llm-setting openai-llm-setting">
                <label for="llm_api_key">{{ _('API Key') }}</label>
                <input type="password" id="llm_api_key" name="llm_api_key" autocomplete="new-password">
                <small>{{ _('API key for the selected provider.') }}</small>
            </div>
            <div class="form-group llm-setting openai-llm-setting">
                <label for="llm_model">{{ _('Model') }}</label>
                <input type="text" id="llm_model" name="llm_model" list="llm_model_list" placeholder="{{ _('Select or type a model') }}">
                <datalist id="llm_model_list">
                    <!-- Options will be dynamically populated by JavaScript -->
                </datalist>
                <small>{{ _('The specific model to use, e.g., gpt-4o.') }}</small>
            </div>

            <h3>{{ _('Statistics Settings') }}</h3>
            <div class="form-group">
                <input type="checkbox" id="stats_enabled" name="stats_enabled" value="true" style="width: auto; margin-right: 5px;">
                <label for="stats_enabled" style="display: inline;">{{ _('Enable Reading Statistics Page') }}</label></br>
                <small>{{ _('Allows you to view your reading statistics after logging in.') }}</small>
            </div>
            <div class="form-group">
                <input type="checkbox" id="stats_public" name="stats_public" value="true" style="width: auto; margin-right: 5px;">
                <label for="stats_public" style="display: inline;">{{ _('Make Statistics Page Public') }}</label></br>
                <small>{{ _('If enabled, your statistics page will be publicly accessible without needing to log in.') }}</small>
            </div>
            <div id="stats_url_container" style="display: none;" class="mcp-docs">
                <h4>{{ _('Your Statistics Page URL') }}</h4>
                <p><a id="stats_url" href="#" target="_blank"></a></p>
            </div>
            
            <h3>{{ _('Two-Factor Authentication (2FA)') }}</h3>
            <div id="2fa_status_container"></div>
            <div id="2fa_setup_container" style="display:none;">
                <p>{{ _('Please use your authenticator app to scan this QR code:') }}</p>
                <div id="qr_code_container"></div>
                <p>{{ _('Or manually enter the key:') }} <code id="otp_secret_key"></code></p>
                <div class="form-group">
                    <label for="otp_code">{{ _('Verification Code') }}</label>
                    <input type="text" id="otp_code" name="otp_code" placeholder="{{ _('Enter the 6-digit code to complete setup') }}" autocomplete="off">
                </div>
                <button type="button" class="button-primary" onclick="verify2FA()">{{ _('Verify and Enable') }}</button>
                <button type="button" class="button" onclick="cancel2FASetup()">{{ _('Cancel') }}</button>
            </div>

            <div style="text-align: right; margin-top: 2rem;">
                <button type="submit" class="button-primary">{{ _('Save User Settings') }}</button>
            </div>
        </form>
    </div>

    <!-- MCP 设置 -->
    <div id="mcpSettings" class="tab-content page-transition">
        <h3>{{ _('MCP API Tokens') }}</h3>
        <p>{{ _('You can use these tokens to interact with your library via the MCP protocol.') }}</p>
        <div id="mcp-token-list">
            <!-- Tokens will be loaded here by JavaScript -->
        </div>
        <div style="text-align: right; margin-top: 1rem;">
            <button class="button-primary" onclick="generateMcpToken()">{{ _('Generate New Token') }}</button>
        </div>

        <div class="mcp-docs">
            <h4>{{ _('MCP Endpoint') }}</h4>
            <p><code>{{ request.host_url.rstrip('/') }}/mcp?token=YOUR_TOKEN</code></p>
            <h4>{{ _('Authentication') }}</h4>
            <p>{{ _('Authenticate by appending the `?token=YOUR_TOKEN` parameter to the URL.') }}</p>
            <h4>{{ _('Prompt Examples') }}</h4>
            <p>{{ _('Here are some examples of natural language prompts you can use with an AI agent. The agent will intelligently call one or more tools to fulfill your request.') }}</p>
            <div class="prompt-examples-container">
                <div class="prompt-card">
                    <h5>{{ _('Simple & Advanced Search') }}</h5>
                    <div class="prompt-item">
                        <p>"{{ _('Find books about Python programming.') }}"</p>
                    </div>
                    <div class="prompt-item">
                        <p>"{{ _('Search for science fiction books by Isaac Asimov published after 1950.') }}"</p>
                    </div>
                </div>
                <div class="prompt-card">
                    <h5>{{ _('Book Management') }}</h5>
                    <div class="prompt-item">
                        <p>"{{ _('What are the 5 most recently added books? Send the first one to my Kindle.') }}"</p>
                    </div>
                    <div class="prompt-item">
                        <p>"{{ _('Push the book \'Dune\' to my Anx reader.') }}"</p>
                    </div>
                    <div class="prompt-item">
                        <p>"{{ _('Generate an audiobook for the book \'The Three-Body Problem\'.') }}"</p>
                    </div>
                    <div class="prompt-item">
                        <p>"{{ _('What is the status of the audiobook generation for \'The Three-Body Problem\'?') }}"</p>
                    </div>
                </div>
                <div class="prompt-card">
                    <h5>{{ _('Content Interaction & Summarization') }}</h5>
                    <div class="prompt-item">
                        <p>"{{ _('Show me the table of contents for the book \'Foundation\'.') }}"</p>
                    </div>
                    <div class="prompt-item">
                        <p>"{{ _('Fetch the first chapter of \'Foundation\' and give me a summary.') }}"</p>
                    </div>
                    <div class="prompt-item">
                        <p>"{{ _('Based on the chapter \'The Psychohistorians\' from the book \'Foundation\', what are the main ideas of psychohistory?') }}"</p>
                    </div>
                    <div class="prompt-item">
                        <p>"{{ _('Read the entire book \'The Little Prince\' and tell me what the fox\'s secret is.') }}"</p>
                    </div>
                </div>
                <div class="prompt-card">
                    <h5>{{ _('Reading Statistics & Progress') }}</h5>
                    <div class="prompt-item">
                        <p>"{{ _('How many words is the book \'Dune\' in total, and list the word count for each chapter.') }}"</p>
                    </div>
                    <div class="prompt-item">
                        <p>"{{ _('How many books have I read this year?') }}"</p>
                    </div>
                    <div class="prompt-item">
                        <p>"{{ _('What\'s my reading progress on \'Dune\'?') }}"</p>
                    </div>
                    <div class="prompt-item">
                        <p>"{{ _('Who is the author of \'Project Hail Mary\' and how long have I been reading it?') }}"</p>
                    </div>
                </div>
            </div>

            <h4>{{ _('Available Tools') }}</h4>
            <p>{{ _("You can get a list of all available tools by calling the `tools/list` method. The currently supported tools are:") }}</p>
            <ul>
                <li><strong>search_books</strong>: {{ _("Search for books in a specified library. library_type: 'anx' (user's currently reading library), 'calibre' (public library). Parameters: `library_type` (str), `search_expression` (str), `limit` (int, optional)") }}</li>
                <li><strong>get_recent_books</strong>: {{ _("Get recent books from a specified library. library_type: 'anx' (user's currently reading library), 'calibre' (public library). Parameters: `library_type` (str), `limit` (int, optional)") }}</li>
                <li><strong>get_book_details</strong>: {{ _("Get details for a specific book in a library. library_type: 'anx' (user's currently reading library), 'calibre' (public library). Parameters: `library_type` (str), `book_id` (int)") }}</li>
                <li><strong>push_calibre_book_to_anx</strong>: {{ _("Push a book from the Calibre library to the user's Anx library. Parameters: `book_id` (int)") }}</li>
                <li><strong>send_book_to_kindle</strong>: {{ _("Send a book from a specified library to Kindle. library_type: 'anx' (user's currently reading library), 'calibre' (public library). Parameters: `library_type` (str), `book_id` (int)") }}</li>
                <li><strong>get_epub_table_of_contents</strong>: {{ _("Get the table of contents for an EPUB book from a specified library. library_type: 'anx' (user's currently reading library), 'calibre' (public library). Parameters: `library_type` (str), `book_id` (int)") }}</li>
                <li><strong>get_epub_chapter_content</strong>: {{ _("Get the content of a specific chapter from an EPUB book. library_type: 'anx' (user's currently reading library), 'calibre' (public library). Parameters: `library_type` (str), `book_id` (int), `chapter_number` (int)") }}</li>
                <li><strong>get_epub_entire_content</strong>: {{ _("Get the entire content of an EPUB book from a specified library. library_type: 'anx' (user's currently reading library), 'calibre' (public library). Parameters: `library_type` (str), `book_id` (int)") }}</li>
                <li><strong>get_book_word_count_stats</strong>: {{ _("Get word count statistics for a book (total and per-chapter). library_type: 'anx' (user's currently reading library), 'calibre' (public library). Parameters: `library_type` (str), `book_id` (int)") }}</li>
                <li><strong>generate_audiobook</strong>: {{ _("Generate an audiobook for a book from either the Anx or Calibre library. Parameters: `library_type` (str), `book_id` (int)") }}</li>
                <li><strong>get_audiobook_generation_status</strong>: {{ _("Get the status of an audiobook generation task by its task ID. Parameters: `task_id` (str)") }}</li>
                <li><strong>get_audiobook_status_by_book</strong>: {{ _("Get the status of the latest audiobook task for a specific book by its ID and library type. Parameters: `library_type` (str), `book_id` (int)") }}</li>
            </ul>
        </div>
    </div>

    <!-- Koreader 同步设置 -->
    <div id="koreaderSettings" class="tab-content page-transition">
        <h3>{{ _('KOReader Sync Settings') }}</h3>
        <div class="mcp-docs">
            <h4>{{ _('Step 1: Configure WebDAV Cloud Storage') }}</h4>
            <ol>
                <li>{{ _('In KOReader, go to `Cloud storage` -> `Add new cloud storage`.') }}</li>
                <li>{{ _('Select `WebDAV`.') }}</li>
                <li><strong>{{ _('Server address') }}</strong>: {{ _('Fill in the address below, and <strong>ensure the path ends with a `/`</strong>.') }}
                    <p><code id="koreader-webdav-url" class="webdav-url" title="{{ _('Click to copy') }}"></code></p>
                </li>
                <li><strong>{{ _('Username') }}</strong>: <code>{{ g.user.username }}</code></li>
                <li><strong>{{ _('Password') }}</strong>: {{ _('Your Anx Calibre Manager login password.') }}</li>
                <li><strong>{{ _('Folder') }}</strong>: <code>/anx/data/file</code></li>
                <li>{{ _('Click `Connect` and save. You should now be able to see your Anx library in KOReader\'s file browser.') }}</li>
            </ol>

            <h4>{{ _('Step 2: Install and Configure the Sync Plugin') }}</h4>
            <ol>
                <li>
                    <strong>{{ _('Download Plugin') }}</strong>: {{ _('Click the button below to download the plugin zip file.') }}
                    <div style="margin-top: 1rem; margin-bottom: 1rem;">
                        <button id="download-koreader-plugin-btn" data-url="{{ url_for('calibre.download_koreader_plugin') }}" class="button-primary">{{ _('Download KOReader Plugin (.zip)') }}</button>
                    </div>
                </li>
                <li><strong>{{ _('Install Plugin') }}</strong>: {{ _('Unzip the downloaded `.zip` file, and you will get a folder named `anx-calibre-manager-koreader-plugin.koplugin`. Copy this <strong>entire folder</strong> to the `koreader/plugins/` directory on your KOReader device.') }}</li>
                <li><strong>{{ _('Restart KOReader') }}</strong>: {{ _('Completely close and reopen the KOReader application to load the new plugin.') }}</li>
                <li><strong>{{ _('Configure Sync Server') }}</strong>:
                    <ul>
                        <li><strong>{{ _('Important') }}</strong>: {{ _('First, please open and start reading a book via the WebDAV set up in the previous step. The plugin menu will <strong>only appear in the reading interface</strong>.') }}</li>
                        <li>{{ _('In the reading interface, go to `Tools (wrench icon)` -> `Next page` -> `More tools` -> `ANX Calibre Manager`.') }}</li>
                        <li>{{ _('Select `Custom sync server`.') }}</li>
                        <li><strong>{{ _('Custom sync server address') }}</strong>: <code>{{ request.host_url.rstrip('/') }}/koreader</code></li>
                        <li>{{ _('Return to the previous menu, select `Login`, and enter your Anx Calibre Manager username and password.') }}</li>
                    </ul>
                </li>
            </ol>
            <p>{{ _('Once configured, the plugin will automatically or manually sync your reading progress and time. You can adjust settings like sync frequency in the plugin menu.') }}</p><br>
            <p><strong>({{ _('Note: Only supports epub book synchronization') }})</strong></p>
        </div>
    </div>

    <!-- 全局设置 (仅限管理员) -->
    {% if g.user and g.user.role == 'admin' %}
    <div id="globalSettings" class="tab-content page-transition">
        <form id="globalSettingsForm" onsubmit="saveGlobalSettings(event)">
            <h3>{{ _('Calibre Connection') }}</h3>
            <div class="form-group">
                <label for="CALIBRE_URL">{{ _('Calibre Server URL') }}</label>
                <input type="url" id="CALIBRE_URL" name="CALIBRE_URL">
            </div>
            <div class="form-group">
                <label for="CALIBRE_USERNAME">{{ _('Calibre Username') }}</label>
                <input type="text" id="CALIBRE_USERNAME" name="CALIBRE_USERNAME">
            </div>
            <div class="form-group">
                <label for="CALIBRE_PASSWORD">{{ _('Calibre Password') }}</label>
                <input type="password" id="CALIBRE_PASSWORD" name="CALIBRE_PASSWORD" placeholder="{{ _('Leave blank to keep unchanged') }}">
            </div>
            <div class="setting-item">
                <label for="CALIBRE_DEFAULT_LIBRARY_ID">{{ _('Default Calibre Library ID') }}</label>
                <input type="text" id="CALIBRE_DEFAULT_LIBRARY_ID" name="CALIBRE_DEFAULT_LIBRARY_ID" placeholder="Calibre_Library">
                <small>{{ _('The default Calibre library ID for browsing, searching, and uploading books. Usually \'Calibre_Library\'.') }}</small>
            </div>
            <div class="form-group">
                <input type="checkbox" id="CALIBRE_ADD_DUPLICATES" name="CALIBRE_ADD_DUPLICATES" value="true" style="width: auto; margin-right: 5px;">
                <label for="CALIBRE_ADD_DUPLICATES" style="display: inline;">{{ _('Allow uploading duplicate books') }}</label></br>
                <small>{{ _('If enabled, Calibre will add the book as a new copy even if it detects a duplicate.') }}</small>
            </div>
            <h3>{{ _('Path Settings') }}</h3>
            <div class="form-group">
                <label for="WEBDAV_ROOT">{{ _('WebDAV Root Path') }}</label>
                <input type="text" id="WEBDAV_ROOT" name="WEBDAV_ROOT">
                <small>{{ _('This is the base path for storing all user Anx libraries. User folders will be automatically created under this path (e.g., /webdav/username).') }}</small>
            </div>

            <h3>{{ _('Default Settings') }}</h3>
            <div class="form-group">
                <label for="DEFAULT_FORMAT_PRIORITY">{{ _('Default Format Priority for New Users') }}</label>
                <input type="text" id="DEFAULT_FORMAT_PRIORITY" name="DEFAULT_FORMAT_PRIORITY">
                <small>{{ _('Default format priority for new users, separated by commas, e.g., azw3,mobi,epub') }}</small>
            </div>

            <h3>{{ _('Audiobook Settings') }}</h3>
            <div class="form-group">
                <label for="AUDIOBOOK_CLEANUP_DAYS">{{ _('Audiobook File Retention Period (days)') }}</label>
                <input type="number" id="AUDIOBOOK_CLEANUP_DAYS" name="AUDIOBOOK_CLEANUP_DAYS" min="0">
                <small>{{ _('Automatically delete generated audiobook files older than this number of days. Set to 0 to disable cleanup.') }}</small>
            </div>
            <div class="form-group">
                <label>{{ _('Manual Cleanup') }}</label>
                <button type="button" class="button button-danger" onclick="cleanupAllAudiobooks()">{{ _('Clean Up All Audiobooks Now') }}</button><br>
                <small>{{ _('Immediately delete all generated audiobook files and update their database records.') }}</small>
            </div>

            <h3>{{ _('SMTP Settings (for Send to Kindle)') }}</h3>
            <div class="form-group">
                <label for="SMTP_SERVER">{{ _('SMTP Server') }}</label>
                <input type="text" id="SMTP_SERVER" name="SMTP_SERVER">
            </div>
            <div class="form-group">
                <label for="SMTP_PORT">{{ _('SMTP Port') }}</label>
                <input type="number" id="SMTP_PORT" name="SMTP_PORT">
            </div>
            <div class="form-group">
                <label for="SMTP_USERNAME">{{ _('SMTP Username (usually your email)') }}</label>
                <input type="text" id="SMTP_USERNAME" name="SMTP_USERNAME">
            </div>
            <div class="form-group">
                <label for="SMTP_PASSWORD">{{ _('SMTP Password') }}</label>
                <input type="password" id="SMTP_PASSWORD" name="SMTP_PASSWORD" autocomplete="new-password">
            </div>
            <div class="form-group">
                <label for="SMTP_ENCRYPTION">{{ _('Encryption Method') }}</label>
                <select id="SMTP_ENCRYPTION" name="SMTP_ENCRYPTION">
                    <option value="none">{{ _('None') }}</option>
                    <option value="starttls">{{ _('STARTTLS') }}</option>
                    <option value="ssl">{{ _('SSL/TLS') }}</option>
                </select>
                <small>{{ _('SSL/TLS is usually used for port 465, STARTTLS is usually used for port 587.') }}</small>
            </div>

            <h3>{{ _('Security') }}</h3>
            <div class="form-group">
                <label for="LOGIN_MAX_ATTEMPTS">{{ _('Login Failure Lock Threshold') }}</label>
                <input type="number" id="LOGIN_MAX_ATTEMPTS" name="LOGIN_MAX_ATTEMPTS" min="0">
                <small>{{ _('Set to 0 to disable this feature.') }}</small>
            </div>
            <div class="form-group">
                <label for="SESSION_LIFETIME_DAYS">{{ _('Session Lifetime (days)') }}</label>
                <input type="number" id="SESSION_LIFETIME_DAYS" name="SESSION_LIFETIME_DAYS" min="1">
                <small>{{ _('The number of days a user\'s session remains valid after logging in.') }}</small>
            </div>

            <div class="form-group">
                <label for="test_email_address">{{ _('Test Inbox') }}</label>
                <input type="email" id="test_email_address" name="test_email_address" placeholder="{{ _('Enter an email address to receive a test email') }}">
            </div>
            <div style="text-align: right; margin-top: 2rem;">
                <button type="button" class="button" onclick="testSmtpSettings()">{{ _('Send Test Email') }}</button>
                <button type="submit" class="button-primary">{{ _('Save Global Settings') }}</button>
            </div>
        </form>
    </div>

    <!-- 用户管理 (仅限管理员) -->
    <div id="userManagement" class="tab-content page-transition">
        <form id="userForm" onsubmit="handleUserFormSubmit(event)" class="form-container" style="margin-bottom: 2rem;">
            <input type="hidden" id="user_id" name="user_id">
            <h3><span id="formTitle">{{ _('Add') }}</span> {{ _('New User') }}</h3>
            <div class="form-group">
                <label for="username">{{ _('Username') }}</label>
                <input type="text" id="username" name="username" required>
            </div>
            <div class="form-group">
                <label for="password">{{ _('Password') }}</label>
                <input type="password" id="password" name="password">
                <small>{{ _('Leave blank to not change the existing user\'s password.') }}</small>
            </div>
            <div class="form-group">
                <label for="role">{{ _('Role') }}</label>
                <select id="role" name="role">
                    <option value="user">{{ _('Normal User') }}</option>
                    <option value="maintainer">{{ _('Calibre Library Maintainer') }}</option>
                    <option value="admin">{{ _('Administrator') }}</option>
                </select>
            </div>
            <div style="text-align: right;">
                <button type="submit" class="button-primary">{{ _('Save') }}</button>
                <button type="button" class="button" onclick="resetUserForm()">{{ _('Cancel') }}</button>
            </div>
        </form>

        <h3>{{ _('Existing Users') }}</h3>
        <table id="userTable">
            <thead>
                <tr>
                    <th>{{ _('ID') }}</th>
                    <th>{{ _('Username') }}</th>
                    <th>{{ _('Role') }}</th>
                    <th>{{ _('Actions') }}</th>
                </tr>
            </thead>
            <tbody>
                <!-- 用户数据将由 JavaScript 动态填充 -->
            </tbody>
        </table>
    </div>

    <!-- 邀请码管理 (仅限管理员) -->
    <div id="inviteCodeManagement" class="tab-content page-transition">
        <form id="inviteCodeForm" onsubmit="generateInviteCode(event)" class="form-container" style="margin-bottom: 2rem;">
            <h3>{{ _('Generate New Invite Code') }}</h3>
            <div class="form-group">
                <label for="custom_code">{{ _('Custom Invite Code') }}</label>
                <input type="text" id="custom_code" name="custom_code" placeholder="{{ _('Leave blank to auto-generate') }}">
                <small>{{ _('Custom invite code (optional). If left blank, a random code will be generated.') }}</small>
            </div>
            <div class="form-group">
                <label for="max_uses">{{ _('Maximum Uses') }}</label>
                <input type="number" id="max_uses" name="max_uses" value="1" min="1">
                <small>{{ _('How many times this invite code can be used') }}</small>
            </div>
            <div class="form-group">
                <label for="expires_hours">{{ _('Expires After (Hours)') }}</label>
                <input type="number" id="expires_hours" name="expires_hours" placeholder="{{ _('Leave blank for no expiration') }}">
                <small>{{ _('Number of hours after which this invite code will expire (optional)') }}</small>
            </div>
            <div style="text-align: right;">
                <button type="submit" class="button-primary">{{ _('Generate Invite Code') }}</button>
            </div>
        </form>

        <h3>{{ _('Existing Invite Codes') }}</h3>
        <table id="inviteCodeTable">
            <thead>
                <tr>
                    <th>{{ _('Code') }}</th>
                    <th>{{ _('Max Uses') }}</th>
                    <th>{{ _('Current Uses') }}</th>
                    <th>{{ _('Created By') }}</th>
                    <th>{{ _('Created At') }}</th>
                    <th>{{ _('Expires At') }}</th>
                    <th>{{ _('Status') }}</th>
                    <th>{{ _('Actions') }}</th>
                </tr>
            </thead>
            <tbody>
                <!-- 邀请码数据将由 JavaScript 动态填充 -->
            </tbody>
        </table>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script id="is-admin-data" type="application/json">{{ (g.user.role == 'admin') | tojson | safe }}</script>
<script id="is-maintainer-data" type="application/json">{{ g.user.is_maintainer | tojson | safe }}</script>
<script src="{{ url_for('static', filename='js/settings.js') }}"></script>
{% endblock %}