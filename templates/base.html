<!DOCTYPE html>
<html lang="{{ g.user.language if g.user and g.user.language else 'zh_Hans' }}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}{{ _('Anx Calibre Manager') }}{% endblock %}</title>

    <!-- PWA & Mobile Meta -->
    {% if g.user and g.user.theme %}
        {% if g.user.theme == 'dark' %}
            <meta name="theme-color" content="#1f1f1f"/>
        {% elif g.user.theme == 'light' %}
            <meta name="theme-color" content="#FFFFFF"/>
        {% else %}
            <!-- auto 模式：使用 CSS 媒体查询动态设置 -->
            <meta name="theme-color" content="#FFFFFF" media="(prefers-color-scheme: light)"/>
            <meta name="theme-color" content="#1f1f1f" media="(prefers-color-scheme: dark)"/>
        {% endif %}
    {% else %}
        <meta name="theme-color" content="#FFFFFF"/>
    {% endif %}
    <link rel="icon" href="{{ url_for('static', filename='logo.svg') }}" type="image/svg+xml">
    <link rel="apple-touch-icon" href="{{ url_for('static', filename='logo.png') }}">
    <link rel="manifest" href="{{ url_for('main.dynamic_manifest') }}">

    <!-- Translations for JS -->
    <script id="js-translations" type="application/json">{{ get_js_translations() | tojson | safe }}</script>
    <script>
        window.translations = JSON.parse(document.getElementById('js-translations').textContent);
        function _(text) {
            return window.translations[text] || text;
        }
    </script>

    <!-- Theme Manager Script -->
    <script>
        (function() {
            const userTheme = '{{ g.user.theme if g.user and g.user.theme else "" }}';
            const savedTheme = userTheme || localStorage.getItem('theme') || 'auto';

            // If the user has a theme set on the server, make sure localStorage is in sync.
            if (userTheme && userTheme !== localStorage.getItem('theme')) {
                localStorage.setItem('theme', userTheme);
            }

            function applyTheme(themeValue) {
                const isAuto = themeValue === 'auto';
                const systemIsDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
                const effectiveTheme = isAuto ? (systemIsDark ? 'dark' : 'light') : themeValue;

                if (effectiveTheme === 'dark') {
                    document.documentElement.classList.add('dark-mode');
                    document.documentElement.setAttribute('data-theme', 'dark');
                } else {
                    document.documentElement.classList.remove('dark-mode');
                    document.documentElement.setAttribute('data-theme', 'light');
                }
                // Store the raw preference (could be 'auto') for other scripts
                document.documentElement.dataset.themePreference = themeValue;
            }

            applyTheme(savedTheme);

            document.addEventListener('DOMContentLoaded', () => {
                // Listen for changes in system theme only if in auto mode
                if (savedTheme === 'auto') {
                    window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', () => {
                        applyTheme('auto');
                    });
                }
            });
        })();
    </script>

    <!-- Stylesheets -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}?v={{ cache_buster }}">
    {% block head_extra %}{% endblock %}
</head>
<body class="{% block body_class %}{% endblock %}">
    <div class="loading-overlay" id="global-loader" style="position: fixed; display: none;">
        <div class="spinner"></div>
    </div>
    {% if not no_nav %}
    <nav class="top-nav">
        <a href="{{ url_for('main.index') }}" class="logo">{{ _('Anx Calibre Manager') }}</a>
        {% if g.user and g.user.id %}
        <div class="nav-links">
            <a href="{{ url_for('main.settings_page') }}" class="button">{{ _('Settings') }}</a>
            <a href="{{ url_for('auth.logout') }}" class="button button-danger">{{ _('Logout') }}</a>
        </div>
        {% endif %}
    </nav>
    {% endif %}

    <div class="container">
        <div class="content-wrapper">
            {% block content %}{% endblock %}
        </div>
    </div>
    
    {% if not no_nav %}
    <div class="bottom-nav">
        <a href="{{ url_for('main.index') }}?view=calibre" class="nav-button" id="nav-home">
            <i class="fas fa-book icon"></i>
            <span>{{ _('Library') }}</span>
        </a>
        <a href="{{ url_for('main.index') }}?view=anx" class="nav-button" id="nav-anx-mobile-view">
             <i class="fas fa-feather-alt icon"></i>
            <span>{{ _('Anx') }}</span>
        </a>
        <a href="{{ url_for('main.settings_page') }}" class="nav-button" id="nav-settings">
            <i class="fas fa-cog icon"></i>
            <span>{{ _('Settings') }}</span>
        </a>
    </div>
    {% endif %}

    <!-- PWA Service Worker Registration -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js').then(registration => {
                    console.log('ServiceWorker registration successful with scope: ', registration.scope);
                    
                    // Listen for the service worker installing a new version.
                    registration.addEventListener('updatefound', () => {
                        const newWorker = registration.installing;
                        newWorker.addEventListener('statechange', () => {
                            if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                // New content is available, please refresh.
                                // For a smoother experience, you might want to show a toast notification
                                // and allow the user to refresh. For simplicity, we'll just reload.
                                console.log('New content is available, refreshing...');
                                window.location.reload();
                            }
                        });
                    });

                }, err => {
                    console.log('ServiceWorker registration failed: ', err);
                });
            });
        }
    </script>
    <script>
    // Global Navigation Enhancement v3
    document.addEventListener('DOMContentLoaded', () => {
        const globalLoader = document.getElementById('global-loader');

        function handleNavClick(event) {
            event.preventDefault();
            
            const targetLink = event.currentTarget;
            const destination = targetLink.href;
            const url = new URL(destination);
            const view = url.searchParams.get('view');

            // If a view is specified (calibre or anx), store it for the index page to use
            if (view) {
                localStorage.setItem('mobileView', view);
            }

            if (globalLoader) {
                globalLoader.style.display = 'flex';
            }

            setTimeout(() => {
                // Navigate to the base URL without the view parameter
                url.searchParams.delete('view');
                window.location.href = url.toString();
            }, 50);
        }

        // Attach event listeners to all navigation buttons
        document.querySelectorAll('.nav-button').forEach(button => {
            button.addEventListener('click', handleNavClick);
        });
    });

    function changeLanguage(lang) {
        const isUserLoggedIn = JSON.parse('{{ (g.user and g.user.id) | tojson }}');
        if (isUserLoggedIn) {
            fetch('/api/user_settings', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ language: lang }),
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    window.location.reload();
                } else {
                    console.error('Failed to change language');
                }
            })
            .catch(error => {
                console.error('Error changing language:', error);
            });
        } else {
            const currentUrl = new URL(window.location.href);
            currentUrl.searchParams.set('lang', lang);
            window.location.href = currentUrl.toString();
        }
    }
    </script>
    {% block scripts %}{% endblock %}
    {% if not no_footer %}
    <footer class="site-footer">
        <div class="language-selector">
            <i class="fas fa-globe"></i>
            <select id="language-select" onchange="changeLanguage(this.value)">
                {% set current_lang = get_locale() %}
                {% for lang, name in available_languages.items() %}
                    <option value="{{ lang }}" {% if lang == current_lang %}selected{% endif %}>{{ name }}</option>
                {% endfor %}
            </select>
        </div>
        <p>{{ _('Having issues or suggestions?') }} <a href="#" id="quick-bug-report-link" target="_blank" rel="noopener noreferrer"><i class="fas fa-bug"></i> {{ _('Bug Report') }}</a> | <a href="https://github.com/ptbsare/anx-calibre-manager/issues/new?template=feature_request.yml" target="_blank" rel="noopener noreferrer"><i class="fas fa-lightbulb"></i> {{ _('Submit Suggestion') }}</a></p>
        <p>{{ _('Find This Helpful?') }} <a href="https://ptbsare.org/about/" target="_blank" rel="noopener noreferrer">{{ _('Buy me a Coffee ☕') }}</a></p>
        <p>Anx Calibre Manager {{ app_version }} by <a href="https://github.com/ptbsare" target="_blank" rel="noopener noreferrer">ptbsare</a></p>
        <script>
        // Generate Quick Bug Report Link with Server System Information (lazy loading)
        (function() {
            const version = '{{ app_version }}';
            const bugReportLink = document.getElementById('quick-bug-report-link');
            
            if (!bugReportLink) return;
            
            // Set default link text
            bugReportLink.innerHTML = '<i class="fas fa-bug"></i> ' + (_('Bug Report') || 'Bug Report');
            
            let systemInfoFetched = false;
            
            // Only fetch system info when user clicks the link
            bugReportLink.addEventListener('click', function(e) {
                if (systemInfoFetched) return; // Already fetched, let the link work normally
                
                e.preventDefault(); // Prevent navigation
                
                // Show loading state
                bugReportLink.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ' + (_('Loading...') || 'Loading...');
                
                // Fetch system information from server
                fetch('/api/system/info')
                    .then(response => response.json())
                    .then(data => {
                        const baseUrl = 'https://github.com/ptbsare/anx-calibre-manager/issues/new';
                        const params = new URLSearchParams({
                            template: 'bug_report.yml',
                            title: '[Bug]: ',
                            version: version,
                            os: data.os || 'Unknown',
                            architecture: data.architecture || 'Unknown',
                            logs: data.container_logs || ''
                        });
                        
                        bugReportLink.href = baseUrl + '?' + params.toString();
                        bugReportLink.innerHTML = '<i class="fas fa-bug"></i> ' + (_('Bug Report') || 'Bug Report');
                        systemInfoFetched = true;
                        
                        // Trigger the navigation
                        window.open(bugReportLink.href, '_blank');
                    })
                    .catch(error => {
                        console.error('Failed to fetch system info:', error);
                        // Fallback: use basic template without pre-filled data
                        const baseUrl = 'https://github.com/ptbsare/anx-calibre-manager/issues/new';
                        const params = new URLSearchParams({
                            template: 'bug_report.yml',
                            version: version
                        });
                        bugReportLink.href = baseUrl + '?' + params.toString();
                        bugReportLink.innerHTML = '<i class="fas fa-bug"></i> ' + (_('Bug Report') || 'Bug Report');
                        systemInfoFetched = true;
                        
                        // Trigger the navigation
                        window.open(bugReportLink.href, '_blank');
                    });
            });
        })();
        </script>
        {% if enable_activity_log %}
        <p class="footer-audit-note">{{ _('The administrator has enabled logging. Your web activities may be recorded.') }}</p>
        {% endif %}
    </footer>
    {% endif %}
</body>
</html>